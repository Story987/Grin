name: Deploy Digital Garden

on:
  push:
    branches: [main]
  workflow_dispatch:

permissions:
  pages: write
  id-token: write

concurrency:
  group: "pages"
  cancel-in-progress: true

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    
    steps:
      # 1. –ó–∞–≥—Ä—É–∂–∞–µ–º –∫–æ–¥
      - name: Checkout repository
        uses: actions/checkout@v4
      
      # 2. –ü—Ä–æ–≤–µ—Ä—è–µ–º –∏—Å—Ö–æ–¥–Ω—ã–µ —Ñ–∞–π–ª—ã
      - name: Check source files
        run: |
          echo "üîç –°–û–î–ï–†–ñ–ò–ú–û–ï src/site/notes:"
          if [ -d "src/site/notes" ]; then
            find src/site/notes -type f 2>/dev/null || echo "–§–∞–π–ª–æ–≤ –Ω–µ—Ç"
            echo ""
            echo "üìä –í—Å–µ–≥–æ —Ñ–∞–π–ª–æ–≤: $(find src/site/notes -type f 2>/dev/null | wc -l)"
          else
            echo "‚ùå –ü–∞–ø–∫–∞ src/site/notes –Ω–µ –Ω–∞–π–¥–µ–Ω–∞"
            exit 1
          fi
      
      # 3. –ö–æ–ø–∏—Ä—É–µ–º —Ñ–∞–π–ª—ã (–ë–ï–ó –æ—á–∏—Å—Ç–∫–∏ –∫–æ—Ä–Ω—è!)
      - name: Copy files
        run: |
          echo "üì¶ –ö–æ–ø–∏—Ä—É—é —Ñ–∞–π–ª—ã..."
          
          # –ü—Ä–æ—Å—Ç–æ –∫–æ–ø–∏—Ä—É–µ–º, –ø–µ—Ä–µ–∑–∞–ø–∏—Å—ã–≤–∞—è —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ
          if [ -d "src/site/notes" ]; then
            cp -rf src/site/notes/. ./ 2>/dev/null || true
            echo "‚úÖ –§–∞–π–ª—ã —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω—ã"
          fi
          
          # –í–∞–∂–Ω–æ: —Å–æ–∑–¥–∞—ë–º .nojekyll –µ—Å–ª–∏ –µ–≥–æ –Ω–µ—Ç
          touch .nojekyll
          echo "‚úÖ .nojekyll —Ñ–∞–π–ª —Å–æ–∑–¥–∞–Ω/–æ–±–Ω–æ–≤–ª—ë–Ω"
      
      # 4. –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç
      - name: Show result
        run: |
          echo "üìÅ –§–∞–π–ª—ã –≤ –∫–æ—Ä–Ω–µ –ø–æ—Å–ª–µ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è:"
          find . -maxdepth 1 -type f ! -name '.git*' | sed 's/^/  /'
      
      # 5. –ó–∞–≥—Ä—É–∂–∞–µ–º –∏ –¥–µ–ø–ª–æ–∏–º
      - name: Upload pages artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: './'
      
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
      
      - name: Success info
        if: success()
        run: |
          echo "üéâ –ì–æ—Ç–æ–≤–æ! –°–∞–π—Ç: https://story987.github.io/Grin/"
