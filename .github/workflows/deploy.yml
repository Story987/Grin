name: Deploy Digital Garden

on:
  push:
    branches: [main]
  workflow_dispatch:

permissions:
  pages: write
  id-token: write

concurrency:
  group: "pages"
  cancel-in-progress: true

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    
    steps:
      # 1. –ó–∞–≥—Ä—É–∂–∞–µ–º –∫–æ–¥
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # –ü–æ–ª–Ω–∞—è –∏—Å—Ç–æ—Ä–∏—è –¥–ª—è –ø—Ä–∞–≤–∏–ª—å–Ω–æ–π —Ä–∞–±–æ—Ç—ã
      
      # 2. –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å—Ç—Ä—É–∫—Ç—É—Ä—É —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è
      - name: Debug - Show repository structure
        run: |
          echo "üîç –°–¢–†–£–ö–¢–£–†–ê –†–ï–ü–û–ó–ò–¢–û–†–ò–Ø:"
          echo "==========================="
          echo "üìÅ –ö–æ—Ä–µ–Ω—å —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è:"
          ls -la
          echo ""
          echo "üìÅ –ü–∞–ø–∫–∞ src/site/notes:"
          if [ -d "src/site/notes" ]; then
            find src/site/notes -type f 2>/dev/null | head -30 || echo "–ù–µ—Ç —Ñ–∞–π–ª–æ–≤"
            echo ""
            echo "üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞:"
            echo "–í—Å–µ–≥–æ —Ñ–∞–π–ª–æ–≤: $(find src/site/notes -type f 2>/dev/null | wc -l)"
            echo "–ü–∞–ø–æ–∫: $(find src/site/notes -type d 2>/dev/null | wc -l)"
          else
            echo "‚ùå –ü–∞–ø–∫–∞ src/site/notes –Ω–µ –Ω–∞–π–¥–µ–Ω–∞!"
            echo "–°–æ–∑–¥–∞—é —Å—Ç—Ä—É–∫—Ç—É—Ä—É..."
            mkdir -p src/site/notes
            echo "# –ú–æ–∏ –∑–∞–º–µ—Ç–∫–∏" > src/site/notes/README.md
          fi
      
      # 3. –ö–æ–ø–∏—Ä—É–µ–º –í–°–ï —Ñ–∞–π–ª—ã —Å –ø—Ä–∞–≤–∏–ª—å–Ω–æ–π —Å—Ç—Ä—É–∫—Ç—É—Ä–æ–π
      - name: Copy ALL files to root
        run: |
          echo "üîÑ –ö–û–ü–ò–†–û–í–ê–ù–ò–ï –§–ê–ô–õ–û–í:"
          echo "====================="
          
          # –ü—Ä–æ–≤–µ—Ä—è–µ–º –∏—Å—Ö–æ–¥–Ω—É—é –ø–∞–ø–∫—É
          if [ ! -d "src/site/notes" ]; then
            echo "‚ùå –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞: –ü–∞–ø–∫–∞ src/site/notes –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç!"
            exit 1
          fi
          
          # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ —Ñ–∞–π–ª—ã –¥–ª—è –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è
          FILE_COUNT=$(find src/site/notes -type f 2>/dev/null | wc -l)
          if [ "$FILE_COUNT" -eq 0 ]; then
            echo "‚ö†Ô∏è –í–Ω–∏–º–∞–Ω–∏–µ: –í src/site/notes –Ω–µ—Ç —Ñ–∞–π–ª–æ–≤ –¥–ª—è –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è"
          else
            echo "üì¶ –ù–∞–π–¥–µ–Ω–æ —Ñ–∞–π–ª–æ–≤ –¥–ª—è –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è: $FILE_COUNT"
          fi
          
          echo ""
          echo "üßπ –û—á–∏—â–∞—é –∫–æ—Ä–Ω–µ–≤—É—é –ø–∞–ø–∫—É (–∫—Ä–æ–º–µ .git –∏ .github)..."
          # –£–¥–∞–ª—è–µ–º –≤—Å—ë, –∫—Ä–æ–º–µ —Å–ª—É–∂–µ–±–Ω—ã—Ö –ø–∞–ø–æ–∫
          find . -maxdepth 1 ! -name '.' ! -name '.git' ! -name '.github' ! -name 'src' -exec rm -rf {} + 2>/dev/null || true
          
          echo "üì§ –ö–æ–ø–∏—Ä—É—é –í–°–Å —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ –ø–∞–ø–∫–∏ notes..."
          # –ò—Å–ø–æ–ª—å–∑—É–µ–º —Ç–æ—á–∫—É –≤ –∫–æ–Ω—Ü–µ –¥–ª—è –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è –í–°–ï–ì–û —Å–æ–¥–µ—Ä–∂–∏–º–æ–≥–æ
          if [ "$(ls -A src/site/notes 2>/dev/null)" ]; then
            # –°–æ–∑–¥–∞—ë–º —Å—Ç—Ä—É–∫—Ç—É—Ä—É –µ—Å–ª–∏ –Ω—É–∂–Ω–æ
            mkdir -p _temp_copy
            cp -r src/site/notes/. _temp_copy/ 2>/dev/null || true
            # –ü–µ—Ä–µ–º–µ—â–∞–µ–º –≤ –∫–æ—Ä–µ–Ω—å
            mv _temp_copy/* ./ 2>/dev/null || true
            rm -rf _temp_copy
            echo "‚úÖ –§–∞–π–ª—ã —É—Å–ø–µ—à–Ω–æ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω—ã"
          else
            echo "‚ö†Ô∏è –ü–∞–ø–∫–∞ src/site/notes –ø—É—Å—Ç–∞"
          fi
          
          # –°–æ–∑–¥–∞—ë–º .nojekyll (–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ!)
          touch .nojekyll
          echo "‚úÖ –°–æ–∑–¥–∞–Ω —Ñ–∞–π–ª .nojekyll"
          
          echo ""
          echo "üìÅ –ò—Ç–æ–≥–æ–≤–∞—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ –≤ –∫–æ—Ä–Ω–µ:"
          ls -la | head -20
          echo "..."
      
      # 4. –°–æ–∑–¥–∞—ë–º –∏–Ω–¥–µ–∫—Å –µ—Å–ª–∏ –µ–≥–æ –Ω–µ—Ç
      - name: Create index if missing
        run: |
          echo "üîç –ü–†–û–í–ï–†–ö–ê INDEX –§–ê–ô–õ–ê:"
          echo "========================"
          
          # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ index —Ñ–∞–π–ª—ã
          if [ -f "index.html" ] || [ -f "index.md" ] || [ -f "index.txt" ]; then
            echo "‚úÖ Index —Ñ–∞–π–ª —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç"
            ls -la index.* 2>/dev/null || true
          else
            echo "‚ö†Ô∏è Index —Ñ–∞–π–ª –Ω–µ –Ω–∞–π–¥–µ–Ω, —Å–æ–∑–¥–∞—é –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π..."
            
            # –°–æ–∑–¥–∞—ë–º HTML —Å –Ω–∞–≤–∏–≥–∞—Ü–∏–µ–π –ø–æ –≤—Å–µ–º —Ñ–∞–π–ª–∞–º
            cat > index.html << 'EOF'
            <!DOCTYPE html>
            <html lang="ru">
            <head>
                <meta charset="UTF-8">
                <meta name="viewport" content="width=device-width, initial-scale=1.0">
                <title>Digital Garden - –í—Å–µ —Ñ–∞–π–ª—ã</title>
                <style>
                    body {
                        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
                        max-width: 900px;
                        margin: 40px auto;
                        padding: 30px;
                        line-height: 1.6;
                        background: #f8f9fa;
                        color: #24292e;
                    }
                    .container {
                        background: white;
                        border-radius: 10px;
                        padding: 40px;
                        box-shadow: 0 2px 10px rgba(0,0,0,0.05);
                    }
                    h1 {
                        color: #2c3e50;
                        border-bottom: 2px solid #3498db;
                        padding-bottom: 15px;
                        margin-bottom: 30px;
                    }
                    ul {
                        list-style: none;
                        padding: 0;
                        column-count: 2;
                        column-gap: 40px;
                    }
                    @media (max-width: 768px) {
                        ul { column-count: 1; }
                    }
                    li {
                        margin: 12px 0;
                        break-inside: avoid;
                    }
                    a {
                        color: #0366d6;
                        text-decoration: none;
                        padding: 8px 12px;
                        display: block;
                        border-radius: 6px;
                        transition: all 0.2s;
                    }
                    a:hover {
                        background: #f1f8ff;
                        color: #005cc5;
                        transform: translateX(5px);
                    }
                    .folder {
                        color: #6a737d;
                        font-weight: bold;
                    }
                    .file {
                        color: #0366d6;
                        padding-left: 20px;
                    }
                    .note {
                        background: #fff8e1;
                        border-left: 4px solid #ffd600;
                        padding: 15px;
                        margin: 20px 0;
                        border-radius: 4px;
                    }
                    footer {
                        margin-top: 40px;
                        color: #6a737d;
                        font-size: 0.9em;
                        text-align: center;
                        padding-top: 20px;
                        border-top: 1px solid #e1e4e8;
                    }
                </style>
            </head>
            <body>
                <div class="container">
                    <h1>üåø Digital Garden</h1>
                    
                    <div class="note">
                        <p>–≠—Ç–æ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–Ω–∞—è —Å—Ç—Ä–∞–Ω–∏—Ü–∞. –î–æ–±–∞–≤—å—Ç–µ —Ñ–∞–π–ª <code>index.html</code> –∏–ª–∏ <code>index.md</code> –≤ –ø–∞–ø–∫—É <code>src/site/notes/</code> –¥–ª—è –∫–∞—Å—Ç–æ–º–Ω–æ–π –≥–ª–∞–≤–Ω–æ–π —Å—Ç—Ä–∞–Ω–∏—Ü—ã.</p>
                    </div>
                    
                    <h2>üìÇ –í—Å–µ –æ–ø—É–±–ª–∏–∫–æ–≤–∞–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã:</h2>
                    <ul id="file-list">
                        <li>–ó–∞–≥—Ä—É–∑–∫–∞ —Å–ø–∏—Å–∫–∞ —Ñ–∞–π–ª–æ–≤...</li>
                    </ul>
                    
                    <footer>
                        <p>–û–±–Ω–æ–≤–ª–µ–Ω–æ: <span id="current-date"></span> | –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –¥–µ–ø–ª–æ–π —á–µ—Ä–µ–∑ GitHub Actions</p>
                    </footer>
                </div>
                
                <script>
                    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ç–µ–∫—É—â—É—é –¥–∞—Ç—É
                    document.getElementById('current-date').textContent = new Date().toLocaleDateString('ru-RU');
                    
                    // –ó–∞–≥—Ä—É–∂–∞–µ–º –∏ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –≤—Å–µ —Ñ–∞–π–ª—ã
                    async function loadFiles() {
                        try {
                            const response = await fetch('.');
                            const html = await response.text();
                            const parser = new DOMParser();
                            const doc = parser.parseFromString(html, 'text/html');
                            const links = Array.from(doc.querySelectorAll('a'));
                            
                            const fileList = document.getElementById('file-list');
                            fileList.innerHTML = '';
                            
                            const files = links
                                .filter(link => {
                                    const href = link.getAttribute('href');
                                    return href && 
                                           !href.includes('?') && 
                                           !href.startsWith('../') &&
                                           href !== '/' &&
                                           link.textContent.trim();
                                })
                                .map(link => ({
                                    name: link.textContent.trim(),
                                    url: link.getAttribute('href'),
                                    isDir: link.getAttribute('href').endsWith('/')
                                }))
                                .sort((a, b) => {
                                    if (a.isDir && !b.isDir) return -1;
                                    if (!a.isDir && b.isDir) return 1;
                                    return a.name.localeCompare(b.name);
                                });
                            
                            if (files.length === 0) {
                                fileList.innerHTML = '<li>–§–∞–π–ª—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã. –î–æ–±–∞–≤—å—Ç–µ —Ñ–∞–π–ª—ã –≤ –ø–∞–ø–∫—É src/site/notes/</li>';
                                return;
                            }
                            
                            files.forEach(file => {
                                const li = document.createElement('li');
                                const a = document.createElement('a');
                                a.href = file.url;
                                a.textContent = file.isDir ? `üìÅ ${file.name}` : `üìÑ ${file.name}`;
                                a.className = file.isDir ? 'folder' : 'file';
                                li.appendChild(a);
                                fileList.appendChild(li);
                            });
                        } catch (error) {
                            document.getElementById('file-list').innerHTML = 
                                '<li>–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å–ø–∏—Å–∫–∞ —Ñ–∞–π–ª–æ–≤</li>';
                            console.error('–û—à–∏–±–∫–∞:', error);
                        }
                    }
                    
                    // –ó–∞–≥—Ä—É–∂–∞–µ–º —Ñ–∞–π–ª—ã –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
                    window.addEventListener('DOMContentLoaded', loadFiles);
                </script>
            </body>
            </html>
            EOF
            
            echo "‚úÖ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π index.html —Å–æ–∑–¥–∞–Ω"
          fi
      
      # 5. –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ñ–∏–Ω–∞–ª—å–Ω—É—é —Å—Ç—Ä—É–∫—Ç—É—Ä—É
      - name: Verify final structure
        run: |
          echo "üìä –§–ò–ù–ê–õ–¨–ù–ê–Ø –ü–†–û–í–ï–†–ö–ê:"
          echo "====================="
          echo "üåê –ö–æ—Ä–Ω–µ–≤–∞—è –ø–∞–ø–∫–∞ —Å–∞–π—Ç–∞:"
          find . -maxdepth 2 -type f | head -30
          echo ""
          echo "üìà –ò—Ç–æ–≥–æ–≤–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞:"
          echo "–í—Å–µ–≥–æ —Ñ–∞–π–ª–æ–≤ –≤ –∫–æ—Ä–Ω–µ: $(find . -maxdepth 1 -type f ! -name '.git*' | wc -l)"
          echo "–í—Å–µ–≥–æ –ø–∞–ø–æ–∫ –≤ –∫–æ—Ä–Ω–µ: $(find . -maxdepth 1 -type d ! -name '.git' | wc -l)"
      
      # 6. –ó–∞–≥—Ä—É–∂–∞–µ–º –∞—Ä—Ç–µ—Ñ–∞–∫—Ç –¥–ª—è GitHub Pages
      - name: Upload pages artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: './'
      
      # 7. –î–µ–ø–ª–æ–∏–º
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
      
      # 8. –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–µ
      - name: Show deployment result
        if: success()
        run: |
          echo ""
          echo "üéâ –£–°–ü–ï–®–ù–´–ô –î–ï–ü–õ–û–ô!"
          echo "=================="
          echo "‚úÖ –í–∞—à Digital Garden –æ–ø—É–±–ª–∏–∫–æ–≤–∞–Ω"
          echo "üåê –ê–¥—Ä–µ—Å —Å–∞–π—Ç–∞: https://story987.github.io/Grin/"
          echo "üïê –í—Ä–µ–º—è –ø—É–±–ª–∏–∫–∞—Ü–∏–∏: $(date '+%Y-%m-%d %H:%M:%S')"
          echo ""
          echo "üìã –°–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏:"
          echo "   1. –û—Ç–∫—Ä–æ–π—Ç–µ https://story987.github.io/Grin/ –≤ –±—Ä–∞—É–∑–µ—Ä–µ"
          echo "   2. –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –≤—Å–µ —Ñ–∞–π–ª—ã –æ—Ç–æ–±—Ä–∞–∂–∞—é—Ç—Å—è"
          echo "   3. –î–æ–±–∞–≤–ª—è–π—Ç–µ –Ω–æ–≤—ã–µ –∑–∞–º–µ—Ç–∫–∏ –≤ src/site/notes/"
          echo "   4. –°–∞–π—Ç –±—É–¥–µ—Ç –æ–±–Ω–æ–≤–ª—è—Ç—å—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø—Ä–∏ –∫–∞–∂–¥–æ–º push"
          echo ""
          echo "üîß –ï—Å–ª–∏ —Ñ–∞–π–ª–æ–≤ –Ω–µ—Ç –Ω–∞ —Å–∞–π—Ç–µ:"
          echo "   ‚Ä¢ –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏ —à–∞–≥–∞ 'Debug - Show repository structure'"
          echo "   ‚Ä¢ –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –≤ src/site/notes/ –µ—Å—Ç—å —Ñ–∞–π–ª—ã"
          echo "   ‚Ä¢ –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ GitHub Pages (Source: GitHub Actions)"
      
      # 9. –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫
      - name: Handle failure
        if: failure()
        run: |
          echo ""
          echo "‚ùå –î–ï–ü–õ–û–ô –ù–ï –£–î–ê–õ–°–Ø"
          echo "================="
          echo "–ü–æ—Å–º–æ—Ç—Ä–∏—Ç–µ –ª–æ–≥–∏ –≤—ã—à–µ –¥–ª—è –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏ –æ—à–∏–±–∫–∏."
          echo ""
          echo "–í–æ–∑–º–æ–∂–Ω—ã–µ –ø—Ä–∏—á–∏–Ω—ã:"
          echo "   ‚Ä¢ –ü–∞–ø–∫–∞ src/site/notes/ –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç"
          echo "   ‚Ä¢ –ù–µ—Ç –ø—Ä–∞–≤ –Ω–∞ –∑–∞–ø–∏—Å—å –≤ –∫–æ—Ä–Ω–µ–≤—É—é –ø–∞–ø–∫—É"
          echo "   ‚Ä¢ –û—à–∏–±–∫–∞ –≤ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ GitHub Pages"
          echo ""
          echo "–ü—Ä–æ–≤–µ—Ä—å—Ç–µ:"
          echo "   1. –°—É—â–µ—Å—Ç–≤—É–µ—Ç –ª–∏ –ø–∞–ø–∫–∞ src/site/notes/ –≤ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–∏"
          echo "   2. –ù–∞—Å—Ç—Ä–æ–π–∫–∏ GitHub Pages (Source: GitHub Actions)"
