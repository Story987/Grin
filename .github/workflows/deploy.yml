name: Deploy Digital Garden

on:
  push:
    branches: [main]
  workflow_dispatch:

permissions:
  pages: write
  id-token: write

concurrency:
  group: "pages"
  cancel-in-progress: true

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Copy notes to root
        run: |
          echo "üìÅ –°–æ–¥–µ—Ä–∂–∏–º–æ–µ src/site/notes:"
          ls -la src/site/notes/ || echo "–ü–∞–ø–∫–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞"
          echo ""
          
          echo "üîÑ –ö–æ–ø–∏—Ä—É—é —Ñ–∞–π–ª—ã –∏–∑ src/site/notes –≤ –∫–æ—Ä–µ–Ω—å..."
          
          # –ö–æ–ø–∏—Ä—É–µ–º —Ñ–∞–π–ª—ã
          if [ -d "src/site/notes" ]; then
            cp -r src/site/notes/* ./ 2>/dev/null || true
            echo "‚úÖ –§–∞–π–ª—ã —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω—ã"
          else
            echo "‚ùå –û—à–∏–±–∫–∞: –ü–∞–ø–∫–∞ src/site/notes –Ω–µ –Ω–∞–π–¥–µ–Ω–∞!"
            exit 1
          fi
          
          # –í–∞–∂–Ω–æ –¥–ª—è GitHub Pages
          touch .nojekyll
          echo "‚úÖ –°–æ–∑–¥–∞–Ω .nojekyll"
      
      - name: Upload pages artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: './'
      
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
      
      - name: Show result
        if: success()
        run: |
          echo "üéâ –°–∞–π—Ç –∑–∞–¥–µ–ø–ª–æ–µ–Ω!"
          echo "üåê URL: https://story987.github.io/Grin/"
          echo "üïê –í—Ä–µ–º—è: $(date)"