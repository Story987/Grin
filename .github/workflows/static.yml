name: Digital Garden with Obsidian Features

on:
  push:
    branches: ["main"]
    paths:
      - 'src/site/notes/**'  # –¢–æ–ª—å–∫–æ –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ –∑–∞–º–µ—Ç–æ–∫
      - '.github/workflows/**'
  workflow_dispatch:

permissions:
  contents: read
  pages: write
  id-token: write

concurrency:
  group: "pages"
  cancel-in-progress: true  # –ù–æ–≤—ã–π –¥–µ–ø–ª–æ–π –æ—Ç–º–µ–Ω—è–µ—Ç —Å—Ç–∞—Ä—ã–π

jobs:
  build-and-deploy:
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # 1. –°–∫–∞—á–∏–≤–∞–µ–º –≥–æ—Ç–æ–≤—ã–µ —à–∞–±–ª–æ–Ω—ã –∏–∑ obsidian-digital-garden
      - name: Download templates from obsidian-garden
        run: |
          echo "üì• –ó–∞–≥—Ä—É–∂–∞—é —à–∞–±–ª–æ–Ω—ã..."
          mkdir -p templates
          
          # –û—Å–Ω–æ–≤–Ω–æ–π CSS (–º–æ–∂–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –∏–ª–∏ –∞–¥–∞–ø—Ç–∏—Ä–æ–≤–∞—Ç—å)
          curl -s -o templates/style.css \
            https://raw.githubusercontent.com/oleeskild/obsidian-digital-garden/main/src/site/assets/css/style.css
          
          # –ò–∫–æ–Ω–∫–∏ –∏ —à—Ä–∏—Ñ—Ç—ã
          mkdir -p templates/assets
          curl -s -o templates/assets/favicon.ico \
            https://github.com/oleeskild/obsidian-digital-garden/raw/main/src/site/assets/favicon.ico
          
          echo "‚úÖ –®–∞–±–ª–æ–Ω—ã –∑–∞–≥—Ä—É–∂–µ–Ω—ã"

      # 2. –ê–Ω–∞–ª–∏–∑–∏—Ä—É–µ–º —Å—Ç—Ä—É–∫—Ç—É—Ä—É –∫–∞–∫ –≤ obsidian-garden
      - name: Analyze notes structure
        id: scan
        run: |
          cd src/site/notes
          echo "üîç –ê–Ω–∞–ª–∏–∑–∏—Ä—É—é —Å—Ç—Ä—É–∫—Ç—É—Ä—É –∑–∞–º–µ—Ç–æ–∫..."
          
          # –°–æ–∑–¥–∞—ë–º —Å—Ç—Ä—É–∫—Ç—É—Ä—É –∫–∞–∫ –≤ obsidian
          cat > notes-structure.json << 'EOF'
          {
            "generated": "$(date)",
            "notes": [
          EOF
          
          # –ù–∞—Ö–æ–¥–∏–º –≤—Å–µ markdown/html —Ñ–∞–π–ª—ã
          first=true
          find . -name "*.md" -o -name "*.html" -o -name "*.htm" | while read file; do
            if [ "$first" = true ]; then
              first=false
            else
              echo "," >> notes-structure.json
            fi
            
            filename=$(basename "$file")
            path=$(dirname "$file" | sed 's|^\./||')
            size=$(stat -c%s "$file" 2>/dev/null || wc -c < "$file")
            
            # –ò–∑–≤–ª–µ–∫–∞–µ–º –∑–∞–≥–æ–ª–æ–≤–æ–∫ (–ø–µ—Ä–≤–∞—è —Å—Ç—Ä–æ–∫–∞ –¥–ª—è .md)
            if [[ "$file" == *.md ]]; then
              title=$(head -1 "$file" | sed 's/^# //')
            else
              title=$(echo "$filename" | sed 's/\.[^.]*$//')
            fi
            
            echo "  {" >> notes-structure.json
            echo "    \"file\": \"$filename\"," >> notes-structure.json
            echo "    \"path\": \"$path\"," >> notes-structure.json
            echo "    \"title\": \"${title:-$filename}\"," >> notes-structure.json
            echo "    \"size\": $size," >> notes-structure.json
            echo "    \"type\": \"$(echo "$filename" | grep -o '\.[^.]*$')\"" >> notes-structure.json
            echo "  }" >> notes-structure.json
          done
          
          echo "]" >> notes-structure.json
          echo "}" >> notes-structure.json
          
          echo "üìä –ù–∞–π–¥–µ–Ω–æ –∑–∞–º–µ—Ç–æ–∫: $(grep -c '"file"' notes-structure.json)"

      # 3. –°–æ–∑–¥–∞—ë–º –≥–ª–∞–≤–Ω—É—é —Å—Ç—Ä–∞–Ω–∏—Ü—É –≤ —Å—Ç–∏–ª–µ obsidian-garden
      - name: Create obsidian-style index
        run: |
          cd src/site/notes
          echo "üé® –°–æ–∑–¥–∞—é —Å—Ç—Ä–∞–Ω–∏—Ü—É –≤ —Å—Ç–∏–ª–µ Obsidian Garden..."
          
          # –ò—Å–ø–æ–ª—å–∑—É–µ–º CSS –∏–∑ obsidian-garden
          cp ../../templates/style.css . 2>/dev/null || echo "–ò—Å–ø–æ–ª—å–∑—É—é —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π CSS"
          
          # –û—Å–Ω–æ–≤–Ω–∞—è —Å—Ç—Ä–∞–Ω–∏—Ü–∞
          cat > index.html << 'HTML'
<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üåø Digital Garden</title>
    <link rel="stylesheet" href="style.css">
    <style>
        /* –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —Å—Ç–∏–ª–∏ –∏–∑ obsidian-garden */
        :root {
            --primary-color: #4a90e2;
            --secondary-color: #7b68ee;
            --bg-color: #0f0f1a;
            --text-color: #e0e0e0;
            --card-bg: #1a1a2e;
            --border-color: #2a2a3e;
        }

        body {
            background: var(--bg-color);
            color: var(--text-color);
            font-family: 'Inter', -apple-system, sans-serif;
        }

        .garden-header {
            text-align: center;
            padding: 3rem 1rem;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            border-bottom: 1px solid var(--border-color);
        }

        .notes-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 1.5rem;
            padding: 2rem;
            max-width: 1400px;
            margin: 0 auto;
        }

        .note-card {
            background: var(--card-bg);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 1.5rem;
            transition: all 0.3s ease;
            text-decoration: none;
            color: inherit;
        }

        .note-card:hover {
            transform: translateY(-5px);
            border-color: var(--primary-color);
            box-shadow: 0 10px 30px rgba(74, 144, 226, 0.2);
        }

        .note-tags {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
            margin-top: 1rem;
        }

        .tag {
            background: rgba(74, 144, 226, 0.1);
            color: var(--primary-color);
            padding: 0.3rem 0.8rem;
            border-radius: 20px;
            font-size: 0.85rem;
        }

        .search-box {
            max-width: 600px;
            margin: 2rem auto;
            padding: 0 2rem;
        }

        #search-input {
            width: 100%;
            padding: 1rem 1.5rem;
            background: var(--card-bg);
            border: 1px solid var(--border-color);
            border-radius: 50px;
            color: var(--text-color);
            font-size: 1rem;
        }

        .backlinks {
            background: var(--card-bg);
            border-radius: 10px;
            padding: 1.5rem;
            margin: 2rem auto;
            max-width: 800px;
        }
    </style>
</head>
<body>
    <div class="garden-header">
        <h1 style="font-size: 3rem; margin-bottom: 1rem;">üåø Digital Garden</h1>
        <p style="color: #aaa; max-width: 600px; margin: 0 auto;">
            –ö–æ–ª–ª–µ–∫—Ü–∏—è –≤–∑–∞–∏–º–æ—Å–≤—è–∑–∞–Ω–Ω—ã—Ö –º—ã—Å–ª–µ–π –∏ –∑–∞–º–µ—Ç–æ–∫
        </p>
    </div>

    <div class="search-box">
        <input type="text" id="search-input" placeholder="üîç –ü–æ–∏—Å–∫ –ø–æ –∑–∞–º–µ—Ç–∫–∞–º...">
    </div>

    <div class="notes-grid" id="notes-container">
        <!-- –ó–∞–º–µ—Ç–∫–∏ –±—É–¥—É—Ç –∑–∞–≥—Ä—É–∂–µ–Ω—ã JavaScript -->
        <p>–ó–∞–≥—Ä—É–∑–∫–∞ –∑–∞–º–µ—Ç–æ–∫...</p>
    </div>

    <div class="backlinks">
        <h3>üìö –í—Å–µ —Ñ–∞–π–ª—ã</h3>
        <div id="all-files"></div>
    </div>

    <script>
        // –ó–∞–≥—Ä—É–∑–∫–∞ —Å—Ç—Ä—É–∫—Ç—É—Ä—ã –∑–∞–º–µ—Ç–æ–∫
        async function loadNotes() {
            try {
                const response = await fetch('notes-structure.json');
                const data = await response.json();
                renderNotes(data.notes);
            } catch (error) {
                document.getElementById('notes-container').innerHTML = 
                    `<div class="note-card"><p>–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏: ${error.message}</p></div>`;
            }
        }

        function renderNotes(notes) {
            const container = document.getElementById('notes-container');
            const allFiles = document.getElementById('all-files');

            let notesHtml = '';
            let filesHtml = '<div style="display: flex; flex-wrap: wrap; gap: 0.5rem;">';

            notes.forEach(note => {
                // –ö–∞—Ä—Ç–æ—á–∫–∞ –∑–∞–º–µ—Ç–∫–∏
                notesHtml += `
                    <a href="${encodeURIComponent(note.path)}/${encodeURIComponent(note.file)}" 
                       class="note-card">
                        <h3>${note.title}</h3>
                        <p style="color: #aaa; font-size: 0.9rem; margin-top: 0.5rem;">
                            ${note.path ? 'üìÅ ' + note.path : 'üìÑ'} ‚Ä¢ 
                            ${Math.ceil(note.size / 1024)} KB
                        </p>
                        <div class="note-tags">
                            <span class="tag">${note.type.replace('.', '')}</span>
                            ${note.path ? `<span class="tag">${note.path.split('/')[0]}</span>` : ''}
                        </div>
                    </a>
                `;
                
                // –ü—Ä–æ—Å—Ç–æ–π —Å–ø–∏—Å–æ–∫ –≤—Å–µ—Ö —Ñ–∞–π–ª–æ–≤
                filesHtml += `
                    <a href="${encodeURIComponent(note.path)}/${encodeURIComponent(note.file)}"
                       style="display: inline-block; padding: 0.3rem 0.8rem; 
                              background: #2a2a3e; border-radius: 6px; 
                              color: #ccc; text-decoration: none; font-size: 0.9rem;">
                        ${note.file}
                    </a>
                `;
            });
            
            filesHtml += '</div>';
            
            container.innerHTML = notesHtml;
            allFiles.innerHTML = filesHtml;
            
            // –ü–æ–∏—Å–∫
            document.getElementById('search-input').addEventListener('input', function(e) {
                const term = e.target.value.toLowerCase();
                const cards = document.querySelectorAll('.note-card');
                
                cards.forEach(card => {
                    const title = card.querySelector('h3').textContent.toLowerCase();
                    const visible = title.includes(term);
                    card.style.display = visible ? 'block' : 'none';
                });
            });
        }
        
        document.addEventListener('DOMContentLoaded', loadNotes);
    </script>
</body>
</html>
HTML
          
          echo "‚úÖ –ì–ª–∞–≤–Ω–∞—è —Å—Ç—Ä–∞–Ω–∏—Ü–∞ —Å–æ–∑–¥–∞–Ω–∞ –≤ —Å—Ç–∏–ª–µ Obsidian Garden"

      # 4. –î–µ–ø–ª–æ–π
      - name: Setup Pages
        uses: actions/configure-pages@v5
        
      - name: Upload artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: 'src/site/notes/'
        
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
