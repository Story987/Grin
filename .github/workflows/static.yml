name: Deploy to GitHub Pages

on:
  push:
    branches: [ "main", "master" ]
    paths:
      - 'src/site/notes/**'  # –¢—Ä–∏–≥–≥–µ—Ä–∏–º —Ç–æ–ª—å–∫–æ –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏—è—Ö –≤ —ç—Ç–æ–π –ø–∞–ø–∫–µ!
      - '.github/workflows/deploy.yml'  # –ò –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ —Å–∞–º–æ–≥–æ workflow
  workflow_dispatch:  # –ú–æ–∂–Ω–æ –∑–∞–ø—É—Å—Ç–∏—Ç—å –≤—Ä—É—á–Ω—É—é

# –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –¥–ª—è –±—ã—Å—Ç—Ä–æ–≥–æ –¥–µ–ø–ª–æ—è
permissions:
  contents: read
  pages: write
  id-token: write

# –ó–∞—â–∏—Ç–∞ –æ—Ç –∫–æ–Ω—Ñ–ª–∏–∫—Ç–æ–≤
concurrency:
  group: "pages"
  cancel-in-progress: true

jobs:
  deploy:
    runs-on: ubuntu-latest
    timeout-minutes: 5  # –ë–µ–∑–æ–ø–∞—Å–Ω—ã–π —Ç–∞–π–º–∞—É—Ç –¥–ª—è –±—ã—Å—Ç—Ä—ã—Ö –¥–µ–ø–ª–æ–µ–≤
    
    steps:
      # 1. –ë—ã—Å—Ç—Ä–∞—è –∑–∞–≥—Ä—É–∑–∫–∞ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è (—Ç–æ–ª—å–∫–æ –ø–æ—Å–ª–µ–¥–Ω–∏–π –∫–æ–º–º–∏—Ç)
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 1  # –¢–æ–ª—å–∫–æ –ø–æ—Å–ª–µ–¥–Ω–∏–π –∫–æ–º–º–∏—Ç - –±—ã—Å—Ç—Ä–µ–µ!
      
      # 2. –°–æ–∑–¥–∞–µ–º –ø–∞–ø–∫—É dist –∏ –∫–æ–ø–∏—Ä—É–µ–º —Ñ–∞–π–ª—ã
      - name: Copy files to dist
        run: |
          # –û—á–∏—â–∞–µ–º –ø—Ä–µ–¥—ã–¥—É—â—É—é —Å–±–æ—Ä–∫—É
          rm -rf dist
          
          # –ö–æ–ø–∏—Ä—É–µ–º —Ç–æ–ª—å–∫–æ –Ω—É–∂–Ω—É—é –ø–∞–ø–∫—É
          mkdir -p dist
          cp -r src/site/notes/* dist/ 2>/dev/null ||:
          
          # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ index.html —Å—É—â–µ—Å—Ç–≤—É–µ—Ç
          if [ ! -f "dist/index.html" ]; then
            echo "‚ö†Ô∏è –í–Ω–∏–º–∞–Ω–∏–µ: index.html –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ src/site/notes/"
            echo "–°–æ–∑–¥–∞—é –ø—Ä–æ—Å—Ç–æ–π index.html..."
            cat > dist/index.html << EOF
            <!DOCTYPE html>
            <html>
            <head>
              <title>Grin Site</title>
              <meta charset="UTF-8">
              <meta name="viewport" content="width=device-width, initial-scale=1.0">
            </head>
            <body>
              <h1>–°–∞–π—Ç –Ω–∞ GitHub Pages</h1>
              <p>–î–æ–±–∞–≤—å—Ç–µ index.html –≤ src/site/notes/</p>
              <p>–ü–æ—Å–ª–µ–¥–Ω–µ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ: $(date)</p>
            </body>
            </html>
            EOF
          fi
          
          # –§–∞–π–ª –¥–ª—è –æ—Ç–∫–ª—é—á–µ–Ω–∏—è Jekyll
          touch dist/.nojekyll
          
          # –ë—ã—Å—Ç—Ä–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ —Ä–∞–∑–º–µ—Ä–∞
          echo "üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ —Å–±–æ—Ä–∫–∏:"
          find dist -type f | wc -l | xargs echo "–§–∞–π–ª–æ–≤:"
          du -sh dist | cut -f1 | xargs echo "–†–∞–∑–º–µ—Ä:"
      
      # 3. –û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ: –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –¥–∞—Ç—ã –≤ —Ñ–∞–π–ª–∞—Ö
      - name: Update timestamps (optional)
        run: |
          # –î–æ–±–∞–≤–ª—è–µ–º –¥–∞—Ç—É –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –≤–æ –≤—Å–µ HTML —Ñ–∞–π–ª—ã
          find dist -name "*.html" -type f | while read file; do
            if grep -q "Last updated" "$file"; then
              sed -i "s/Last updated:.*/Last updated: $(date '+%Y-%m-%d %H:%M:%S')/" "$file"
            fi
          done || true
      
      # 4. –°–æ–∑–¥–∞–µ–º sitemap.xml –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
      - name: Generate sitemap
        run: |
          BASE_URL="https://story987.github.io/Grin"
          
          cat > dist/sitemap.xml << EOF
          <?xml version="1.0" encoding="UTF-8"?>
          <urlset xmlns="http://www.sitemaps.org/schemas/sitemap/0.9">
            <url>
              <loc>${BASE_URL}/</loc>
              <lastmod>$(date -Iseconds)</lastmod>
              <changefreq>daily</changefreq>
              <priority>1.0</priority>
            </url>
          EOF
          
          # –î–æ–±–∞–≤–ª—è–µ–º –≤—Å–µ HTML —Ñ–∞–π–ª—ã –≤ sitemap
          find dist -name "*.html" -type f | while read file; do
            if [[ "$file" != "dist/sitemap.xml" ]]; then
              rel_path="${file#dist/}"
              echo "    <url>" >> dist/sitemap.xml
              echo "      <loc>${BASE_URL}/${rel_path}</loc>" >> dist/sitemap.xml
              echo "      <lastmod>$(date -Iseconds)</lastmod>" >> dist/sitemap.xml
              echo "      <changefreq>weekly</changefreq>" >> dist/sitemap.xml
              echo "      <priority>0.8</priority>" >> dist/sitemap.xml
              echo "    </url>" >> dist/sitemap.xml
            fi
          done
          
          echo "  </urlset>" >> dist/sitemap.xml
          echo "‚úÖ Sitemap —Å–æ–∑–¥–∞–Ω"
      
      # 5. –ó–∞–≥—Ä—É–∂–∞–µ–º –∞—Ä—Ç–µ—Ñ–∞–∫—Ç
      - name: Upload to GitHub Pages
        uses: actions/upload-pages-artifact@v3
        with:
          path: './dist'
      
      # 6. –î–µ–ø–ª–æ–∏–º
      - name: Deploy
        id: deployment
        uses: actions/deploy-pages@v4
      
      # 7. –ë—ã—Å—Ç—Ä–æ–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ —Å—Ç–∞—Ç—É—Å–µ
      - name: Deployment status
        run: |
          if [ "${{ job.status }}" = "success" ]; then
            echo "‚úÖ –°–∞–π—Ç —É—Å–ø–µ—à–Ω–æ –∑–∞–¥–µ–ø–ª–æ–µ–Ω!"
            echo "üåê URL: https://story987.github.io/Grin"
            echo "üïê –í—Ä–µ–º—è: $(date '+%H:%M:%S')"
          else
            echo "‚ùå –î–µ–ø–ª–æ–π –Ω–µ —É–¥–∞–ª—Å—è"
          fi
