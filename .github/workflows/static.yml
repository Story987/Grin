name: Digital Garden - Dynamic Index

on:
  push:
    branches: ["main"]
    paths:
      - 'src/site/notes/**'      # Срабатывает при изменении заметок
      - '.github/workflows/**'  # Или самого скрипта
  workflow_dispatch:           # Позволяет запустить вручную

permissions:
  contents: read
  pages: write
  id-token: write

concurrency:
  group: "pages"
  cancel-in-progress: true

jobs:
  deploy:
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Scan and Generate File List
        run: |
          echo "93 Начинаю системное сканирование файлов..."
          cd src/site/notes/
          
          # Создаем простой список имен файлов для JavaScript
          # Исключаем служебные файлы, чтобы они не мозолили глаза
          find . -type f ! -name "index.html" ! -name "files-list.txt" | sed 's|^\./||' | sort > files-list.txt
          
          echo "96 Найдено файлов: $(wc -l < files-list.txt)"

      - name: Build Index Page
        run: |
          cd src/site/notes
          echo "96 Сборка динамического интерфейса через echo..."

          # --- HTML Структура ---
          echo '<!DOCTYPE html>' > index.html
          echo '<html lang="ru">' >> index.html
          echo '<head>' >> index.html
          echo '  <meta charset="UTF-8">' >> index.html
          echo '  <meta name="viewport" content="width=device-width, initial-scale=1.0">' >> index.html
          echo '  <title>91 My Digital Garden</title>' >> index.html
          echo '  <style>' >> index.html
          echo '    body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; margin: 0; background: #0d1117; color: #c9d1d9; line-height: 1.6; }' >> index.html
          echo '    .container { max-width: 1000px; margin: 40px auto; padding: 0 20px; }' >> index.html
          echo '    h1 { color: #58a6ff; border-bottom: 1px solid #30363d; padding-bottom: 10px; font-size: 2.5rem; }' >> index.html
          echo '    .search-box { width: 100%; padding: 12px; background: #161b22; border: 1px solid #30363d; border-radius: 6px; color: white; margin-bottom: 20px; font-size: 1rem; }' >> index.html
          echo '    .grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 15px; }' >> index.html
          echo '    .card { background: #161b22; border: 1px solid #30363d; border-radius: 8px; padding: 15px; text-decoration: none; color: inherit; transition: 0.2s; }' >> index.html
          echo '    .card:hover { border-color: #58a6ff; background: #1c2128; transform: translateY(-2px); }' >> index.html
          echo '    .card-title { color: #58a6ff; font-weight: bold; margin-bottom: 5px; display: block; overflow: hidden; text-overflow: ellipsis; }' >> index.html
          echo '    .card-meta { font-size: 0.8rem; color: #8b949e; }' >> index.html
          echo '    footer { margin-top: 50px; text-align: center; color: #8b949e; font-size: 0.9rem; }' >> index.html
          echo '  </style>' >> index.html
          echo '</head>' >> index.html
          echo '<body>' >> index.html
          echo '  <div class="container">' >> index.html
          echo '    <h1>91 Digital Garden</h1>' >> index.html
          echo '    <input type="text" class="search-box" id="search" placeholder="93 Поиск по саду...">' >> index.html
          echo '    <div id="garden-grid" class="grid"><p>Загрузка мыслей...</p></div>' >> index.html
          echo '    <footer>' >> index.html
          echo '      <p>Обновлено: '$(date +'%d.%m.%Y %H:%M')' (Actions)</p>' >> index.html
          echo '    </footer>' >> index.html
          echo '  </div>' >> index.html

          # --- JavaScript Логика ---
          echo '  <script>' >> index.html
          echo '    async function init() {' >> index.html
          echo '      try {' >> index.html
          echo '        const resp = await fetch("files-list.txt");' >> index.html
          echo '        const text = await resp.text();' >> index.html
          echo '        const files = text.split("\\n").filter(f => f.trim());' >> index.html
          echo '        render(files);' >> index.html
          echo '        ' >> index.html
          echo '        document.getElementById("search").oninput = (e) => {' >> index.html
          echo '          const term = e.target.value.toLowerCase();' >> index.html
          echo '          render(files.filter(f => f.toLowerCase().includes(term)));' >> index.html
          echo '        };' >> index.html
          echo '      } catch (err) {' >> index.html
          echo '        document.getElementById("garden-grid").innerHTML = "74 Ошибка загрузки списка";' >> index.html
          echo '      }' >> index.html
          echo '    }' >> index.html
          echo '    ' >> index.html
          echo '    function render(list) {' >> index.html
          echo '      const grid = document.getElementById("garden-grid");' >> index.html
          echo '      grid.innerHTML = list.map(file => {' >> index.html
          echo '        const name = file.split("/").pop().replace(".md", "").replace(".html", "");' >> index.html
          echo '        const folder = file.includes("/") ? file.substring(0, file.lastIndexOf("/")) : "Корень";' >> index.html
          echo '        return `<a href="${encodeURIComponent(file)}" class="card">' >> index.html
          echo '          <span class="card-title">${name}</span>' >> index.html
          echo '          <span class="card-meta">97 ${folder}</span>' >> index.html
          echo '        </a>`;' >> index.html
          echo '      }).join("") || "<p>Ничего не найдено</p>";' >> index.html
          echo '    }' >> index.html
          echo '    init();' >> index.html
          echo '  </script>' >> index.html
          echo '</body>' >> index.html
          echo '</html>' >> index.html

      - name: Upload to GitHub Pages
        uses: actions/upload-pages-artifact@v3
        with:
          path: 'src/site/notes/'

      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4