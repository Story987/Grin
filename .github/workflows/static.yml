name: Deploy Digital Garden with Auto-Generated Index

on:
  push:
    branches: ["main"]
  workflow_dispatch:

permissions:
  contents: read
  pages: write
  id-token: write

concurrency:
  group: "pages"
  cancel-in-progress: false

jobs:
  deploy:
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      # üé® –®–ê–ì 1: –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å–æ–∑–¥–∞—ë–º –∫—Ä–∞—Å–∏–≤—É—é –≥–ª–∞–≤–Ω—É—é —Å—Ç—Ä–∞–Ω–∏—Ü—É
      - name: Generate index.html with all gardens
        run: |
          echo "üåø –ù–∞—á–∏–Ω–∞—é –≥–µ–Ω–µ—Ä–∞—Ü–∏—é –≥–ª–∞–≤–Ω–æ–π —Å—Ç—Ä–∞–Ω–∏—Ü—ã –¥–ª—è —Ü–∏—Ñ—Ä–æ–≤—ã—Ö —Å–∞–¥–æ–≤..."
          
          # –ü–µ—Ä–µ—Ö–æ–¥–∏–º –≤ –ø–∞–ø–∫—É —Å —Å–∞–¥–∞–º–∏
          cd src/site/notes/
          
          # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ –ø–∞–ø–∫–∏
          if [ ! -d "$(ls -d */ 2>/dev/null | head -1)" ]; then
            echo "‚ùå –û—à–∏–±–∫–∞: –í –ø–∞–ø–∫–µ notes –Ω–µ—Ç –ø–æ–¥–ø–∞–ø–æ–∫!"
            exit 1
          fi
          
          # –°–æ–∑–¥–∞—ë–º index.html —Å —Å–æ–≤—Ä–µ–º–µ–Ω–Ω—ã–º –¥–∏–∑–∞–π–Ω–æ–º
          cat > index.html << 'HTML_HEADER'
<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üåø –¶–∏—Ñ—Ä–æ–≤—ã–µ —Å–∞–¥—ã</title>
    <style>
        :root {
            --primary: #2ea44f;
            --bg: #f6f8fa;
            --card: #ffffff;
            --text: #24292f;
            --border: #d0d7de;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: var(--bg);
            color: var(--text);
            line-height: 1.6;
            padding: 20px;
            max-width: 1000px;
            margin: 0 auto;
        }
        header { 
            text-align: center; 
            margin: 40px 0 60px 0;
            padding-bottom: 20px;
            border-bottom: 2px solid var(--border);
        }
        h1 { 
            font-size: 2.8rem; 
            margin-bottom: 10px;
            color: var(--primary);
        }
        .subtitle { 
            color: #6e7781; 
            font-size: 1.2rem;
            margin-bottom: 30px;
        }
        .stats {
            background: var(--card);
            border-radius: 12px;
            padding: 15px;
            margin: 30px 0;
            text-align: center;
            border: 1px solid var(--border);
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
        }
        .gardens-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 30px;
        }
        .garden-card {
            background: var(--card);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 24px;
            transition: all 0.2s ease;
            text-decoration: none;
            color: inherit;
            display: block;
        }
        .garden-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 8px 24px rgba(46, 164, 79, 0.15);
            border-color: var(--primary);
        }
        .garden-icon { 
            font-size: 2rem; 
            margin-bottom: 15px;
        }
        .garden-name { 
            font-size: 1.3rem; 
            font-weight: 600;
            margin-bottom: 8px;
            color: var(--primary);
        }
        .garden-path { 
            color: #6e7781; 
            font-size: 0.9rem;
            font-family: monospace;
            word-break: break-all;
            margin-top: 10px;
            padding: 8px;
            background: #f6f8fa;
            border-radius: 6px;
        }
        footer {
            margin-top: 60px;
            text-align: center;
            color: #6e7781;
            font-size: 0.9rem;
            padding-top: 20px;
            border-top: 1px solid var(--border);
        }
        @media (max-width: 768px) {
            body { padding: 15px; }
            h1 { font-size: 2.2rem; }
            .gardens-grid { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>
    <header>
        <h1>üåø –¶–∏—Ñ—Ä–æ–≤—ã–µ —Å–∞–¥—ã</h1>
        <p class="subtitle">–ö–æ–ª–ª–µ–∫—Ü–∏—è –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã—Ö –∑–Ω–∞–Ω–∏–π –∏ –∑–∞–º–µ—Ç–æ–∫</p>
    </header>
    
    <div class="stats">
        üìö –í—Å–µ–≥–æ —Å–∞–¥–æ–≤: <strong id="garden-count">0</strong> ‚Ä¢ 
        üïê –û–±–Ω–æ–≤–ª–µ–Ω–æ: <span id="current-date">—Å–µ–≥–æ–¥–Ω—è</span>
    </div>
    
    <div class="gardens-grid">
HTML_HEADER

          # –ì–ï–ù–ï–†–ò–†–£–ï–ú –ö–ê–†–¢–û–ß–ö–ò –î–õ–Ø –ö–ê–ñ–î–û–ô –ü–ê–ü–ö–ò
          garden_count=0
          for dir in */; do
            dir_name="${dir%/}"
            
            # –≠–º–æ–¥–∑–∏ –¥–ª—è —Ä–∞–∑–Ω—ã—Ö —Ç–∏–ø–æ–≤ —Å–∞–¥–æ–≤
            if [[ "$dir_name" == *"–¶–∏—Ñ—Ä–æ–≤–æ–π"* ]] || [[ "$dir_name" == *"Digital"* ]]; then
              emoji="üåê"
            elif [[ "$dir_name" == *"–õ–∏—á–Ω—ã–π"* ]] || [[ "$dir_name" == *"Personal"* ]]; then
              emoji="üîí"
            elif [[ "$dir_name" == *"–ü—Ä–æ–µ–∫—Ç"* ]] || [[ "$dir_name" == *"Project"* ]]; then
              emoji="üöÄ"
            elif [[ "$dir_name" == *"–ó–∞–º–µ—Ç–∫"* ]] || [[ "$dir_name" == *"Note"* ]]; then
              emoji="üìù"
            else
              emoji="üìÅ"
            fi
            
            # –≠–∫—Ä–∞–Ω–∏—Ä—É–µ–º –¥–ª—è URL
            dir_url="${dir// /%20}"
            
            # –î–æ–±–∞–≤–ª—è–µ–º –∫–∞—Ä—Ç–æ—á–∫—É —Å–∞–¥–∞
            cat >> index.html << HTML_CARD
        <a href="${dir_url}/" class="garden-card">
            <div class="garden-icon">${emoji}</div>
            <div class="garden-name">${dir_name}</div>
            <div class="garden-path">/${dir_url}/</div>
        </a>
HTML_CARD
            
            ((garden_count++))
          done
          
          # –ó–∞–≤–µ—Ä—à–∞–µ–º HTML
          cat >> index.html << 'HTML_FOOTER'
    </div>
    
    <footer>
        <p>üöÄ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–æ GitHub Actions ‚Ä¢ 
           <a href="https://github.com/Story987/Grin" style="color: #0969da;">–ò—Å—Ö–æ–¥–Ω—ã–π –∫–æ–¥</a>
        </p>
    </footer>
    
    <script>
        // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
        document.getElementById('garden-count').textContent = $garden_count;
        document.getElementById('current-date').textContent = new Date().toLocaleDateString('ru-RU', {
            year: 'numeric',
            month: 'long',
            day: 'numeric',
            hour: '2-digit',
            minute: '2-digit'
        });
        
        // –î–æ–±–∞–≤–ª—è–µ–º –ø–æ–∏—Å–∫ –ø–æ —Å–∞–¥–∞–º (–ø—Ä–æ—Å—Ç–æ–π –≤–∞—Ä–∏–∞–Ω—Ç)
        const searchHTML = `
            <div style="margin: 30px 0; text-align: center;">
                <input type="text" id="garden-search" placeholder="–ü–æ–∏—Å–∫ —Å–∞–¥–æ–≤..." 
                       style="padding: 12px; width: 80%; max-width: 400px; border-radius: 8px; border: 1px solid #d0d7de;">
            </div>
        `;
        document.querySelector('.stats').insertAdjacentHTML('afterend', searchHTML);
        
        // –§—É–Ω–∫—Ü–∏—è –ø–æ–∏—Å–∫–∞
        document.getElementById('garden-search').addEventListener('input', function(e) {
            const searchTerm = e.target.value.toLowerCase();
            const cards = document.querySelectorAll('.garden-card');
            
            cards.forEach(card => {
                const name = card.querySelector('.garden-name').textContent.toLowerCase();
                const path = card.querySelector('.garden-path').textContent.toLowerCase();
                
                if (name.includes(searchTerm) || path.includes(searchTerm)) {
                    card.style.display = 'block';
                } else {
                    card.style.display = 'none';
                }
            });
        });
    </script>
</body>
</html>
HTML_FOOTER
          
          echo "‚úÖ –°–æ–∑–¥–∞–Ω –∫—Ä–∞—Å–∏–≤—ã–π index.html —Å $garden_count —Å–∞–¥–∞–º–∏"
          echo "üìÅ –°–ø–∏—Å–æ–∫ —Å–∞–¥–æ–≤:"
          ls -d */ | sed 's|/$||' | sed 's/^/   ‚Ä¢ /'
        
      # üì¶ –®–ê–ì 2: –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º –∏ –¥–µ–ø–ª–æ–∏–º
      - name: Setup GitHub Pages
        uses: actions/configure-pages@v5
        
      - name: Upload to GitHub Pages
        uses: actions/upload-pages-artifact@v3
        with:
          # –ó–∞–≥—Ä—É–∂–∞–µ–º –≤—Å—é –ø–∞–ø–∫—É notes
          path: 'src/site/notes/'
        
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
