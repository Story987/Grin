name: Digital Garden with Obsidian Features

on:
  push:
    branches: ["main"]
    paths:
      - 'src/site/notes/**'  # –¢–æ–ª—å–∫–æ –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ –∑–∞–º–µ—Ç–æ–∫
      - '.github/workflows/**'
  workflow_dispatch:

permissions:
  contents: read
  pages: write
  id-token: write

concurrency:
  group: "pages"
  cancel-in-progress: true  # –ù–æ–≤—ã–π –¥–µ–ø–ª–æ–π –æ—Ç–º–µ–Ω—è–µ—Ç —Å—Ç–∞—Ä—ã–π

jobs:
  build-and-deploy:
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # 1. –°–∫–∞—á–∏–≤–∞–µ–º –≥–æ—Ç–æ–≤—ã–µ —à–∞–±–ª–æ–Ω—ã –∏–∑ obsidian-digital-garden
      - name: Download templates from obsidian-garden
        run: |
          echo "üì• –ó–∞–≥—Ä—É–∂–∞—é —à–∞–±–ª–æ–Ω—ã..."
          mkdir -p templates
          
          # –û—Å–Ω–æ–≤–Ω–æ–π CSS (–º–æ–∂–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –∏–ª–∏ –∞–¥–∞–ø—Ç–∏—Ä–æ–≤–∞—Ç—å)
          curl -s -o templates/style.css \
            https://raw.githubusercontent.com/oleeskild/obsidian-digital-garden/main/src/site/assets/css/style.css
          
          # –ò–∫–æ–Ω–∫–∏ –∏ —à—Ä–∏—Ñ—Ç—ã
          mkdir -p templates/assets
          curl -s -o templates/assets/favicon.ico \
            https://github.com/oleeskild/obsidian-digital-garden/raw/main/src/site/assets/favicon.ico
          
          echo "‚úÖ –®–∞–±–ª–æ–Ω—ã –∑–∞–≥—Ä—É–∂–µ–Ω—ã"

      # 2. –ê–Ω–∞–ª–∏–∑–∏—Ä—É–µ–º —Å—Ç—Ä—É–∫—Ç—É—Ä—É –∫–∞–∫ –≤ obsidian-garden (–ë–ï–ó HEREDOC)
      - name: Analyze notes structure
        id: scan
        run: |
          cd src/site/notes
          echo "üîç –ê–Ω–∞–ª–∏–∑–∏—Ä—É—é —Å—Ç—Ä—É–∫—Ç—É—Ä—É –∑–∞–º–µ—Ç–æ–∫..."
          
          # –ù–∞—á–∏–Ω–∞–µ–º —Å–æ–∑–¥–∞–Ω–∏–µ JSON —Ñ–∞–π–ª–∞
          echo '{' > notes-structure.json
          echo '  "generated": "'$(date)'",' >> notes-structure.json
          echo '  "notes": [' >> notes-structure.json
          
          # –ù–∞—Ö–æ–¥–∏–º –≤—Å–µ markdown/html —Ñ–∞–π–ª—ã
          file_count=0
          first=true
          find . -name "*.md" -o -name "*.html" -o -name "*.htm" | while read file; do
            if [ "$first" = true ]; then
              first=false
            else
              echo ',' >> notes-structure.json
            fi
            
            filename=$(basename "$file")
            path=$(dirname "$file" | sed 's|^\./||')
            size=$(stat -c%s "$file" 2>/dev/null || wc -c < "$file")
            
            # –ò–∑–≤–ª–µ–∫–∞–µ–º –∑–∞–≥–æ–ª–æ–≤–æ–∫ (–ø–µ—Ä–≤–∞—è —Å—Ç—Ä–æ–∫–∞ –¥–ª—è .md)
            if [[ "$file" == *.md ]]; then
              title=$(head -1 "$file" | sed 's/^# //')
            else
              title=$(echo "$filename" | sed 's/\.[^.]*$//')
            fi
            
            # –ï—Å–ª–∏ title –ø—É—Å—Ç–æ–π, –∏—Å–ø–æ–ª—å–∑—É–µ–º filename
            if [ -z "$title" ]; then
              title="$filename"
            fi
            
            file_type=$(echo "$filename" | grep -o '\.[^.]*$')
            
            echo '    {' >> notes-structure.json
            echo '      "file": "'$filename'",' >> notes-structure.json
            echo '      "path": "'$path'",' >> notes-structure.json
            echo '      "title": "'$title'",' >> notes-structure.json
            echo '      "size": '$size',' >> notes-structure.json
            echo '      "type": "'$file_type'"' >> notes-structure.json
            echo '    }' >> notes-structure.json
            
            file_count=$((file_count + 1))
          done
          
          echo '  ]' >> notes-structure.json
          echo '}' >> notes-structure.json
          
          echo "üìä –ù–∞–π–¥–µ–Ω–æ –∑–∞–º–µ—Ç–æ–∫: $file_count"

      # 3. –°–æ–∑–¥–∞—ë–º –≥–ª–∞–≤–Ω—É—é —Å—Ç—Ä–∞–Ω–∏—Ü—É –≤ —Å—Ç–∏–ª–µ obsidian-garden (–ë–ï–ó HEREDOC)
      - name: Create obsidian-style index
        run: |
          cd src/site/notes
          echo "üé® –°–æ–∑–¥–∞—é —Å—Ç—Ä–∞–Ω–∏—Ü—É –≤ —Å—Ç–∏–ª–µ Obsidian Garden..."
          
          # –ò—Å–ø–æ–ª—å–∑—É–µ–º CSS –∏–∑ obsidian-garden
          cp ../../templates/style.css . 2>/dev/null || echo "–ò—Å–ø–æ–ª—å–∑—É—é —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π CSS"
          
          # –û—Å–Ω–æ–≤–Ω–∞—è —Å—Ç—Ä–∞–Ω–∏—Ü–∞ - —Å–æ–∑–¥–∞–µ–º —á–µ—Ä–µ–∑ echo –ø–æ—Å—Ç—Ä–æ—á–Ω–æ
          echo '<!DOCTYPE html>' > index.html
          echo '<html lang="ru">' >> index.html
          echo '<head>' >> index.html
          echo '    <meta charset="UTF-8">' >> index.html
          echo '    <meta name="viewport" content="width=device-width, initial-scale=1.0">' >> index.html
          echo '    <title>üåø Digital Garden</title>' >> index.html
          echo '    <link rel="stylesheet" href="style.css">' >> index.html
          echo '    <style>' >> index.html
          echo '        /* –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —Å—Ç–∏–ª–∏ –∏–∑ obsidian-garden */' >> index.html
          echo '        :root {' >> index.html
          echo '            --primary-color: #4a90e2;' >> index.html
          echo '            --secondary-color: #7b68ee;' >> index.html
          echo '            --bg-color: #0f0f1a;' >> index.html
          echo '            --text-color: #e0e0e0;' >> index.html
          echo '            --card-bg: #1a1a2e;' >> index.html
          echo '            --border-color: #2a2a3e;' >> index.html
          echo '        }' >> index.html
          echo '' >> index.html
          echo '        body {' >> index.html
          echo '            background: var(--bg-color);' >> index.html
          echo '            color: var(--text-color);' >> index.html
          echo '            font-family: "Inter", -apple-system, sans-serif;' >> index.html
          echo '        }' >> index.html
          echo '' >> index.html
          echo '        .garden-header {' >> index.html
          echo '            text-align: center;' >> index.html
          echo '            padding: 3rem 1rem;' >> index.html
          echo '            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);' >> index.html
          echo '            border-bottom: 1px solid var(--border-color);' >> index.html
          echo '        }' >> index.html
          echo '' >> index.html
          echo '        .notes-grid {' >> index.html
          echo '            display: grid;' >> index.html
          echo '            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));' >> index.html
          echo '            gap: 1.5rem;' >> index.html
          echo '            padding: 2rem;' >> index.html
          echo '            max-width: 1400px;' >> index.html
          echo '            margin: 0 auto;' >> index.html
          echo '        }' >> index.html
          echo '' >> index.html
          echo '        .note-card {' >> index.html
          echo '            background: var(--card-bg);' >> index.html
          echo '            border: 1px solid var(--border-color);' >> index.html
          echo '            border-radius: 12px;' >> index.html
          echo '            padding: 1.5rem;' >> index.html
          echo '            transition: all 0.3s ease;' >> index.html
          echo '            text-decoration: none;' >> index.html
          echo '            color: inherit;' >> index.html
          echo '        }' >> index.html
          echo '' >> index.html
          echo '        .note-card:hover {' >> index.html
          echo '            transform: translateY(-5px);' >> index.html
          echo '            border-color: var(--primary-color);' >> index.html
          echo '            box-shadow: 0 10px 30px rgba(74, 144, 226, 0.2);' >> index.html
          echo '        }' >> index.html
          echo '' >> index.html
          echo '        .note-tags {' >> index.html
          echo '            display: flex;' >> index.html
          echo '            flex-wrap: wrap;' >> index.html
          echo '            gap: 0.5rem;' >> index.html
          echo '            margin-top: 1rem;' >> index.html
          echo '        }' >> index.html
          echo '' >> index.html
          echo '        .tag {' >> index.html
          echo '            background: rgba(74, 144, 226, 0.1);' >> index.html
          echo '            color: var(--primary-color);' >> index.html
          echo '            padding: 0.3rem 0.8rem;' >> index.html
          echo '            border-radius: 20px;' >> index.html
          echo '            font-size: 0.85rem;' >> index.html
          echo '        }' >> index.html
          echo '' >> index.html
          echo '        .search-box {' >> index.html
          echo '            max-width: 600px;' >> index.html
          echo '            margin: 2rem auto;' >> index.html
          echo '            padding: 0 2rem;' >> index.html
          echo '        }' >> index.html
          echo '' >> index.html
          echo '        #search-input {' >> index.html
          echo '            width: 100%;' >> index.html
          echo '            padding: 1rem 1.5rem;' >> index.html
          echo '            background: var(--card-bg);' >> index.html
          echo '            border: 1px solid var(--border-color);' >> index.html
          echo '            border-radius: 50px;' >> index.html
          echo '            color: var(--text-color);' >> index.html
          echo '            font-size: 1rem;' >> index.html
          echo '        }' >> index.html
          echo '' >> index.html
          echo '        .backlinks {' >> index.html
          echo '            background: var(--card-bg);' >> index.html
          echo '            border-radius: 10px;' >> index.html
          echo '            padding: 1.5rem;' >> index.html
          echo '            margin: 2rem auto;' >> index.html
          echo '            max-width: 800px;' >> index.html
          echo '        }' >> index.html
          echo '    </style>' >> index.html
          echo '</head>' >> index.html
          echo '<body>' >> index.html
          echo '    <div class="garden-header">' >> index.html
          echo '        <h1 style="font-size: 3rem; margin-bottom: 1rem;">üåø Digital Garden</h1>' >> index.html
          echo '        <p style="color: #aaa; max-width: 600px; margin: 0 auto;">' >> index.html
          echo '            –ö–æ–ª–ª–µ–∫—Ü–∏—è –≤–∑–∞–∏–º–æ—Å–≤—è–∑–∞–Ω–Ω—ã—Ö –º—ã—Å–ª–µ–π –∏ –∑–∞–º–µ—Ç–æ–∫' >> index.html
          echo '        </p>' >> index.html
          echo '    </div>' >> index.html
          echo '' >> index.html
          echo '    <div class="search-box">' >> index.html
          echo '        <input type="text" id="search-input" placeholder="üîç –ü–æ–∏—Å–∫ –ø–æ –∑–∞–º–µ—Ç–∫–∞–º...">' >> index.html
          echo '    </div>' >> index.html
          echo '' >> index.html
          echo '    <div class="notes-grid" id="notes-container">' >> index.html
          echo '        <!-- –ó–∞–º–µ—Ç–∫–∏ –±—É–¥—É—Ç –∑–∞–≥—Ä—É–∂–µ–Ω—ã JavaScript -->' >> index.html
          echo '        <p>–ó–∞–≥—Ä—É–∑–∫–∞ –∑–∞–º–µ—Ç–æ–∫...</p>' >> index.html
          echo '    </div>' >> index.html
          echo '' >> index.html
          echo '    <div class="backlinks">' >> index.html
          echo '        <h3>üìö –í—Å–µ —Ñ–∞–π–ª—ã</h3>' >> index.html
          echo '        <div id="all-files"></div>' >> index.html
          echo '    </div>' >> index.html
          echo '' >> index.html
          echo '    <script>' >> index.html
          echo '        // –ó–∞–≥—Ä—É–∑–∫–∞ —Å—Ç—Ä—É–∫—Ç—É—Ä—ã –∑–∞–º–µ—Ç–æ–∫' >> index.html
          echo '        async function loadNotes() {' >> index.html
          echo '            try {' >> index.html
          echo '                const response = await fetch("notes-structure.json");' >> index.html
          echo '                const data = await response.json();' >> index.html
          echo '                renderNotes(data.notes);' >> index.html
          echo '            } catch (error) {' >> index.html
          echo '                document.getElementById("notes-container").innerHTML = ' >> index.html
          echo '                    `<div class="note-card"><p>–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏: ${error.message}</p></div>`;' >> index.html
          echo '            }' >> index.html
          echo '        }' >> index.html
          echo '' >> index.html
          echo '        function renderNotes(notes) {' >> index.html
          echo '            const container = document.getElementById("notes-container");' >> index.html
          echo '            const allFiles = document.getElementById("all-files");' >> index.html
          echo '' >> index.html
          echo '            let notesHtml = "";' >> index.html
          echo '            let filesHtml = "<div style=\"display: flex; flex-wrap: wrap; gap: 0.5rem;\">";' >> index.html
          echo '' >> index.html
          echo '            notes.forEach(note => {' >> index.html
          echo '                // –ö–∞—Ä—Ç–æ—á–∫–∞ –∑–∞–º–µ—Ç–∫–∏' >> index.html
          echo '                notesHtml += `' >> index.html
          echo '                    <a href="${encodeURIComponent(note.path)}/${encodeURIComponent(note.file)}" ' >> index.html
          echo '                       class="note-card">' >> index.html
          echo '                        <h3>${note.title}</h3>' >> index.html
          echo '                        <p style="color: #aaa; font-size: 0.9rem; margin-top: 0.5rem;">' >> index.html
          echo '                            ${note.path ? "üìÅ " + note.path : "üìÑ"} ‚Ä¢ ' >> index.html
          echo '                            ${Math.ceil(note.size / 1024)} KB' >> index.html
          echo '                        </p>' >> index.html
          echo '                        <div class="note-tags">' >> index.html
          echo '                            <span class="tag">${note.type.replace(".", "")}</span>' >> index.html
          echo '                            ${note.path ? `<span class="tag">${note.path.split("/")[0]}</span>` : ""}' >> index.html
          echo '                        </div>' >> index.html
          echo '                    </a>' >> index.html
          echo '                `;' >> index.html
          echo '                ' >> index.html
          echo '                // –ü—Ä–æ—Å—Ç–æ–π —Å–ø–∏—Å–æ–∫ –≤—Å–µ—Ö —Ñ–∞–π–ª–æ–≤' >> index.html
          echo '                filesHtml += `' >> index.html
          echo '                    <a href="${encodeURIComponent(note.path)}/${encodeURIComponent(note.file)}"' >> index.html
          echo '                       style="display: inline-block; padding: 0.3rem 0.8rem; ' >> index.html
          echo '                              background: #2a2a3e; border-radius: 6px; ' >> index.html
          echo '                              color: #ccc; text-decoration: none; font-size: 0.9rem;">' >> index.html
          echo '                        ${note.file}' >> index.html
          echo '                    </a>' >> index.html
          echo '                `;' >> index.html
          echo '            });' >> index.html
          echo '            ' >> index.html
          echo '            filesHtml += "</div>";' >> index.html
          echo '            ' >> index.html
          echo '            container.innerHTML = notesHtml;' >> index.html
          echo '            allFiles.innerHTML = filesHtml;' >> index.html
          echo '            ' >> index.html
          echo '            // –ü–æ–∏—Å–∫' >> index.html
          echo '            document.getElementById("search-input").addEventListener("input", function(e) {' >> index.html
          echo '                const term = e.target.value.toLowerCase();' >> index.html
          echo '                const cards = document.querySelectorAll(".note-card");' >> index.html
          echo '                ' >> index.html
          echo '                cards.forEach(card => {' >> index.html
          echo '                    const title = card.querySelector("h3").textContent.toLowerCase();' >> index.html
          echo '                    const visible = title.includes(term);' >> index.html
          echo '                    card.style.display = visible ? "block" : "none";' >> index.html
          echo '                });' >> index.html
          echo '            });' >> index.html
          echo '        }' >> index.html
          echo '        ' >> index.html
          echo '        document.addEventListener("DOMContentLoaded", loadNotes);' >> index.html
          echo '    </script>' >> index.html
          echo '</body>' >> index.html
          echo '</html>' >> index.html
          
          echo "‚úÖ –ì–ª–∞–≤–Ω–∞—è —Å—Ç—Ä–∞–Ω–∏—Ü–∞ —Å–æ–∑–¥–∞–Ω–∞ –≤ —Å—Ç–∏–ª–µ Obsidian Garden"

      # 4. –î–µ–ø–ª–æ–π
      - name: Setup Pages
        uses: actions/configure-pages@v5
        
      - name: Upload artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: 'src/site/notes/'
        
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
