name: Deploy Grin Digital Garden to GitHub Pages

on:
  push:
    branches: [ "main" ]
    paths:
      - 'src/site/notes/**'
      - '.github/workflows/deploy.yml'
  workflow_dispatch:

permissions:
  contents: read
  pages: write
  id-token: write

concurrency:
  group: "pages"
  cancel-in-progress: true

env:
  BASE_URL: "https://story987.github.io/Grin"
  SITE_DIR: "src/site/notes"
  OUTPUT_DIR: "_site"

jobs:
  deploy:
    runs-on: ubuntu-latest
    timeout-minutes: 3
    
    steps:
      # 1. –ë—ã—Å—Ç—Ä–∞—è –∑–∞–≥—Ä—É–∑–∫–∞ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 1
      
      # 2. –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏–µ –∏—Å—Ö–æ–¥–Ω–æ–π –ø–∞–ø–∫–∏
      - name: Validate source directory
        run: |
          if [ ! -d "$SITE_DIR" ]; then
            echo "‚ùå –û—à–∏–±–∫–∞: –ü–∞–ø–∫–∞ $SITE_DIR –Ω–µ –Ω–∞–π–¥–µ–Ω–∞!"
            echo "–°–æ–∑–¥–∞—é –±–∞–∑–æ–≤—É—é —Å—Ç—Ä—É–∫—Ç—É—Ä—É..."
            mkdir -p "$SITE_DIR"
            cat > "$SITE_DIR/index.html" << EOF
            <!DOCTYPE html>
            <html>
            <head>
              <title>Grin Digital Garden</title>
              <base href="$BASE_URL/">
              <meta charset="UTF-8">
              <meta name="viewport" content="width=device-width, initial-scale=1.0">
              <style>
                body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; 
                       max-width: 800px; margin: 0 auto; padding: 40px 20px; line-height: 1.6; }
                h1 { color: #24292e; border-bottom: 1px solid #e1e4e8; padding-bottom: 10px; }
                .note { background: #f6f8fa; padding: 20px; border-radius: 6px; margin: 20px 0; }
                code { background: #f6f8fa; padding: 2px 6px; border-radius: 3px; font-family: 'SFMono-Regular', Consolas, monospace; }
              </style>
            </head>
            <body>
              <h1>üåø Grin Digital Garden</h1>
              <p>Welcome to my digital garden. This is a space for thoughts, ideas, and notes to grow.</p>
              
              <div class="note">
                <h2>üöÄ Quick Start</h2>
                <p>Add your notes as HTML files in <code>src/site/notes/</code></p>
                <p>Every time you push changes, this site will automatically update.</p>
              </div>
              
              <div class="note">
                <h2>üîó Useful Links</h2>
                <ul>
                  <li><a href="/sitemap.xml">Sitemap</a> - For search engines</li>
                  <li><a href="/feed.xml">RSS Feed</a> - Subscribe to updates</li>
                  <li><a href="https://github.com/Story987/Grin">GitHub Repository</a></li>
                </ul>
              </div>
            </body>
            </html>
            EOF
            echo "‚úÖ –°–æ–∑–¥–∞–Ω–∞ –±–∞–∑–æ–≤–∞—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ –≤ $SITE_DIR"
          else
            echo "‚úÖ –ü–∞–ø–∫–∞ $SITE_DIR –Ω–∞–π–¥–µ–Ω–∞"
            echo "üìä –°–æ–¥–µ—Ä–∂–∏—Ç: $(find "$SITE_DIR" -type f | wc -l) —Ñ–∞–π–ª–æ–≤"
          fi
      
      # 3. –ü–æ–¥–≥–æ—Ç–∞–≤–ª–∏–≤–∞–µ–º –ø–∞–ø–∫—É –¥–ª—è —Å–±–æ—Ä–∫–∏ (—Å –æ—á–∏—Å—Ç–∫–æ–π)
      - name: Prepare build directory
        run: |
          # –£–¥–∞–ª—è–µ–º —Å—Ç–∞—Ä—É—é —Å–±–æ—Ä–∫—É –µ—Å–ª–∏ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç
          rm -rf "$OUTPUT_DIR"
          mkdir -p "$OUTPUT_DIR"
          
          # –ö–æ–ø–∏—Ä—É–µ–º –í–°–Å —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ, –≤–∫–ª—é—á–∞—è –ø–æ–¥–ø–∞–ø–∫–∏
          echo "üìÅ –ö–æ–ø–∏—Ä—É—é —Ñ–∞–π–ª—ã –∏–∑ $SITE_DIR –≤ $OUTPUT_DIR..."
          if [ -n "$(ls -A "$SITE_DIR" 2>/dev/null)" ]; then
            # –ò—Å–ø–æ–ª—å–∑—É–µ–º rsync –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è —Å—Ç—Ä—É–∫—Ç—É—Ä—ã –∏ –ø—Ä–∞–≤
            rsync -av "$SITE_DIR/" "$OUTPUT_DIR/" --exclude=".*" || cp -r "$SITE_DIR"/* "$OUTPUT_DIR/" 2>/dev/null || true
          fi
          
          # –§–ò–ö–°: –£–±–µ–¥–∏–º—Å—è, —á—Ç–æ –≤—Å–µ —Ñ–∞–π–ª—ã –∏–º–µ—é—Ç –ø—Ä–∞–≤–∏–ª—å–Ω—ã–µ –ø—Ä–∞–≤–∞
          chmod -R a+r "$OUTPUT_DIR"
          
          echo "‚úÖ –§–∞–π–ª—ã —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω—ã"
      
      # 4. –°–æ–∑–¥–∞–µ–º –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ —Ñ–∞–π–ª—ã –¥–ª—è GitHub Pages
      - name: Create GitHub Pages files
        run: |
          cd "$OUTPUT_DIR"
          
          # 1. .nojekyll - –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏ –≤–∞–∂–Ω–æ!
          touch .nojekyll
          echo "‚úÖ –°–æ–∑–¥–∞–Ω .nojekyll"
          
          # 2. index.html –µ—Å–ª–∏ –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç
          if [ ! -f "index.html" ]; then
            echo "‚ö†Ô∏è index.html –Ω–µ –Ω–∞–π–¥–µ–Ω, —Å–æ–∑–¥–∞—é..."
            cat > index.html << EOF
            <!DOCTYPE html>
            <html>
            <head>
              <title>Grin Digital Garden</title>
              <base href="$BASE_URL/">
              <meta charset="UTF-8">
              <meta name="viewport" content="width=device-width, initial-scale=1.0">
            </head>
            <body>
              <h1>Digital Garden Index</h1>
              <p>No index.html found in $SITE_DIR.</p>
              <p>Available files:</p>
              <ul>
                <!-- Files will be listed by JavaScript -->
              </ul>
              <script>
                // Auto-list all HTML files
                fetch('.')
                  .then(r => r.text())
                  .then(html => {
                    const parser = new DOMParser();
                    const doc = parser.parseFromString(html, 'text/html');
                    const links = Array.from(doc.querySelectorAll('a[href$=".html"]'))
                      .filter(a => !a.href.includes('?') && !a.textContent.includes('Parent Directory'));
                    
                    const ul = document.querySelector('ul');
                    links.forEach(link => {
                      const li = document.createElement('li');
                      const a = document.createElement('a');
                      a.href = link.getAttribute('href');
                      a.textContent = link.textContent || link.getAttribute('href');
                      li.appendChild(a);
                      ul.appendChild(li);
                    });
                    
                    if (links.length === 0) {
                      ul.innerHTML = '<li>No HTML files found</li>';
                    }
                  });
              </script>
            </body>
            </html>
            EOF
          fi
          
          # 3. robots.txt –¥–ª—è SEO
          cat > robots.txt << EOF
          User-agent: *
          Allow: /
          Disallow: /admin/
          Disallow: /private/
          
          Sitemap: $BASE_URL/sitemap.xml
          
          # Grin Digital Garden
          # All public notes are indexable
          EOF
          
          echo "‚úÖ –°–æ–∑–¥–∞–Ω robots.txt"
      
      # 5. –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º sitemap.xml —Å –ø—Ä–∞–≤–∏–ª—å–Ω—ã–º baseURL
      - name: Generate sitemap.xml
        run: |
          cd "$OUTPUT_DIR"
          
          cat > sitemap.xml << EOF
          <?xml version="1.0" encoding="UTF-8"?>
          <urlset xmlns="http://www.sitemaps.org/schemas/sitemap/0.9"
                  xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
                  xsi:schemaLocation="http://www.sitemaps.org/schemas/sitemap/0.9
                  http://www.sitemaps.org/schemas/sitemap/0.9/sitemap.xsd">
          EOF
          
          # –§—É–Ω–∫—Ü–∏—è –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è URL –≤ sitemap
          add_to_sitemap() {
            local file="$1"
            local rel_path="${file#./}"
            local lastmod=$(date -Iseconds -r "$file" 2>/dev/null || date -Iseconds)
            
            cat >> sitemap.xml << EOF
            <url>
              <loc>$BASE_URL/$rel_path</loc>
              <lastmod>$lastmod</lastmod>
              <changefreq>weekly</changefreq>
              <priority>0.7</priority>
            </url>
          EOF
          }
          
          # –î–æ–±–∞–≤–ª—è–µ–º index.html –ø–µ—Ä–≤—ã–º
          if [ -f "index.html" ]; then
            cat >> sitemap.xml << EOF
            <url>
              <loc>$BASE_URL/</loc>
              <lastmod>$(date -Iseconds)</lastmod>
              <changefreq>daily</changefreq>
              <priority>1.0</priority>
            </url>
          EOF
          fi
          
          # –î–æ–±–∞–≤–ª—è–µ–º –≤—Å–µ HTML —Ñ–∞–π–ª—ã
          find . -name "*.html" -type f ! -name "sitemap.xml" | while read file; do
            if [ "$file" != "./index.html" ]; then
              add_to_sitemap "$file"
            fi
          done
          
          echo "</urlset>" >> sitemap.xml
          echo "‚úÖ Sitemap —Å–æ–∑–¥–∞–Ω —Å $BASE_URL –∫–∞–∫ –±–∞–∑–æ–≤—ã–π URL"
      
      # 6. –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º RSS feed.xml
      - name: Generate RSS feed
        run: |
          cd "$OUTPUT_DIR"
          
          cat > feed.xml << EOF
          <?xml version="1.0" encoding="UTF-8"?>
          <rss version="2.0" xmlns:atom="http://www.w3.org/2005/Atom">
          <channel>
            <title>Grin Digital Garden</title>
            <link>$BASE_URL</link>
            <description>A growing collection of notes and ideas</description>
            <language>en</language>
            <lastBuildDate>$(date -R)</lastBuildDate>
            <atom:link href="$BASE_URL/feed.xml" rel="self" type="application/rss+xml"/>
          EOF
          
          # –î–æ–±–∞–≤–ª—è–µ–º –ø–æ—Å–ª–µ–¥–Ω–∏–µ 15 HTML —Ñ–∞–π–ª–æ–≤ (–∫—Ä–æ–º–µ index.html) –≤ RSS
          find . -name "*.html" -type f ! -name "index.html" ! -name "feed.xml" ! -name "sitemap.xml" | \
            head -15 | while read file; do
            rel_path="${file#./}"
            title=$(echo "${rel_path%.html}" | sed 's|/| : |g; s/_/ /g; s/-/ /g')
            
            cat >> feed.xml << EOF
            <item>
              <title>$title</title>
              <link>$BASE_URL/$rel_path</link>
              <guid>$BASE_URL/$rel_path</guid>
              <pubDate>$(date -R)</pubDate>
            </item>
          EOF
          done
          
          echo "  </channel>" >> feed.xml
          echo "</rss>" >> feed.xml
          echo "‚úÖ RSS feed —Å–æ–∑–¥–∞–Ω"
      
      # 7. –ü—Ä–æ–≤–µ—Ä—è–µ–º –∏ –æ–ø—Ç–∏–º–∏–∑–∏—Ä—É–µ–º —Å–±–æ—Ä–∫—É
      - name: Verify and optimize build
        run: |
          cd "$OUTPUT_DIR"
          
          echo "üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–±–æ—Ä–∫–∏:"
          echo "------------------"
          echo "üìÅ –ü–∞–ø–∫–∞: $(pwd)"
          echo "üìä –§–∞–π–ª–æ–≤: $(find . -type f | wc -l)"
          echo "üìà –†–∞–∑–º–µ—Ä: $(du -sh . | cut -f1)"
          echo ""
          echo "‚úÖ –û–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ —Ñ–∞–π–ª—ã:"
          [ -f ".nojekyll" ] && echo "  ‚úì .nojekyll" || echo "  ‚úó .nojekyll"
          [ -f "index.html" ] && echo "  ‚úì index.html" || echo "  ‚úó index.html"
          [ -f "sitemap.xml" ] && echo "  ‚úì sitemap.xml" || echo "  ‚úó sitemap.xml"
          [ -f "feed.xml" ] && echo "  ‚úì feed.xml" || echo "  ‚úó feed.xml"
          [ -f "robots.txt" ] && echo "  ‚úì robots.txt" || echo "  ‚úó robots.txt"
          
          # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å—Ç—Ä—É–∫—Ç—É—Ä—É
          echo ""
          echo "üìÇ –°—Ç—Ä—É–∫—Ç—É—Ä–∞:"
          find . -maxdepth 2 -type f -name "*.html" | head -10 | sed 's/^/  /'
          [ $(find . -name "*.html" | wc -l) -gt 10 ] && echo "  ... –∏ –µ—â—ë $(($(find . -name "*.html" | wc -l)-10)) —Ñ–∞–π–ª–æ–≤"
      
      # 8. –ó–∞–≥—Ä—É–∂–∞–µ–º –∞—Ä—Ç–µ—Ñ–∞–∫—Ç
      - name: Upload artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: './_site'
      
      # 9. –î–µ–ø–ª–æ–∏–º
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
      
      # 10. –ò—Ç–æ–≥–æ–≤–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è
      - name: Deployment summary
        if: success()
        run: |
          echo ""
          echo "üéâ DEPLOYMENT SUCCESSFUL"
          echo "========================"
          echo "üåê Site URL:    $BASE_URL"
          echo "üó∫Ô∏è Sitemap:     $BASE_URL/sitemap.xml"
          echo "üì∞ RSS Feed:    $BASE_URL/feed.xml"
          echo "ü§ñ Robots.txt:  $BASE_URL/robots.txt"
          echo "üïê Deployed at: $(date '+%Y-%m-%d %H:%M:%S %Z')"
          echo ""
          echo "üìù Source files in: src/site/notes/"
          echo "üì¶ Build output in: _site/"
          echo ""
          echo "üöÄ Next steps:"
          echo "   1. Visit $BASE_URL"
          echo "   2. Check if everything looks good"
          echo "   3. Add more notes to src/site/notes/"
          echo "   4. Commit and push to update automatically"
          
      # 11. –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫
      - name: Handle failure
        if: failure()
        run: |
          echo "‚ùå DEPLOYMENT FAILED"
          echo "===================="
          echo "Error details above ‚Üë"
          echo ""
          echo "üîß Troubleshooting:"
          echo "   1. Check if src/site/notes/ exists"
          echo "   2. Verify there are readable files"
          echo "   3. Check GitHub Pages settings"
          echo "   4. Look for error messages above"
