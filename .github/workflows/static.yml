name: Deploy Digital Garden

on:
  push:
    branches: ["main"]
  workflow_dispatch:

permissions:
  contents: read
  pages: write
  id-token: write

concurrency:
  group: "pages"
  cancel-in-progress: false

jobs:
  deploy:
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      # –®–ê–ì 1: –ü—Ä–æ–≤–µ—Ä—è–µ–º –∏ –≥–æ—Ç–æ–≤–∏–º –ø–∞–ø–∫—É notes
      - name: Prepare notes directory
        run: |
          echo "üîç –ü—Ä–æ–≤–µ—Ä—è—é —Å—Ç—Ä—É–∫—Ç—É—Ä—É –ø—Ä–æ–µ–∫—Ç–∞..."
          
          # 1. –ü—Ä–æ–≤–µ—Ä—è–µ–º, —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –ª–∏ –ø–∞–ø–∫–∞ src/site/notes/
          if [ ! -d "src/site/notes" ]; then
            echo "‚ö†Ô∏è –ü–∞–ø–∫–∞ src/site/notes –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç. –°–æ–∑–¥–∞—é..."
            mkdir -p src/site/notes
          fi
          
          # 2. –ü–µ—Ä–µ—Ö–æ–¥–∏–º –≤ –ø–∞–ø–∫—É
          cd src/site/notes/
          echo "üìÅ –¢–µ–∫—É—â–∞—è –ø–∞–ø–∫–∞: $(pwd)"
          
          # 3. –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ
          echo "üìã –°–æ–¥–µ—Ä–∂–∏–º–æ–µ –ø–∞–ø–∫–∏:"
          ls -la || echo "–ü–∞–ø–∫–∞ –ø—É—Å—Ç–∞"
          
          # 4. –°—á–∏—Ç–∞–µ–º –ø–∞–ø–∫–∏ (—Å–∞–¥—ã)
          GARDEN_COUNT=$(find . -maxdepth 1 -type d ! -name "." | wc -l)
          echo "üåø –ù–∞–π–¥–µ–Ω–æ –ø–∞–ø–æ–∫-—Å–∞–¥–æ–≤: $GARDEN_COUNT"
        
      # –®–ê–ì 2: –°–æ–∑–¥–∞—ë–º –ì–õ–ê–í–ù–£–Æ —Å—Ç—Ä–∞–Ω–∏—Ü—É (index.html)
      - name: Create main index.html
        run: |
          cd src/site/notes/
          
          # –ü–†–û–°–¢–ï–ô–®–ò–ô HTML –∫–æ—Ç–æ—Ä—ã–π —Ç–æ—á–Ω–æ —Ä–∞–±–æ—Ç–∞–µ—Ç
          cat > index.html << 'EOF'
<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ú–æ–π —Ü–∏—Ñ—Ä–æ–≤–æ–π —Å–∞–¥</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 40px 20px;
            line-height: 1.6;
            color: #24292e;
        }
        h1 { color: #2ea44f; }
        .garden-list { margin: 30px 0; }
        .garden-item {
            display: block;
            padding: 15px;
            margin: 10px 0;
            background: #f6f8fa;
            border-radius: 6px;
            border: 1px solid #e1e4e8;
            text-decoration: none;
            color: inherit;
        }
        .garden-item:hover {
            background: #e1e4e8;
            border-color: #d1d5da;
        }
        .status {
            padding: 10px;
            background: #f1f8ff;
            border-radius: 6px;
            margin: 20px 0;
        }
    </style>
</head>
<body>
    <h1>üåø –î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ –º–æ–π —Ü–∏—Ñ—Ä–æ–≤–æ–π —Å–∞–¥!</h1>
    
    <div class="status">
        <p>‚úÖ GitHub Pages —É—Å–ø–µ—à–Ω–æ —Ä–∞–∑–≤—ë—Ä–Ω—É—Ç</p>
        <p>üìÖ –î–∞—Ç–∞: <span id="current-date">–∑–∞–≥—Ä—É–∑–∫–∞...</span></p>
    </div>
    
    <h2>üìÅ –î–æ—Å—Ç—É–ø–Ω—ã–µ —Å–∞–¥—ã:</h2>
    <div class="garden-list" id="gardens-list">
        <!-- –°–ø–∏—Å–æ–∫ —Å–∞–¥–æ–≤ –±—É–¥–µ—Ç —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω JavaScript -->
        <p>–ó–∞–≥—Ä—É–∑–∫–∞ —Å–ø–∏—Å–∫–∞ —Å–∞–¥–æ–≤...</p>
    </div>
    
    <script>
        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –¥–∞—Ç—ã
        function updateDate() {
            const now = new Date();
            document.getElementById('current-date').textContent = 
                now.toLocaleDateString('ru-RU') + ' ' + now.toLocaleTimeString('ru-RU');
        }
        
        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–∏—Å–∫–∞ –∏ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –ø–∞–ø–æ–∫
        function loadGardens() {
            const list = document.getElementById('gardens-list');
            
            try {
                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ç–µ—Å—Ç–æ–≤—É—é —Å—Å—ã–ª–∫—É (–¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏)
                list.innerHTML = `
                    <a href="test-garden/" class="garden-item">
                        <strong>üìÅ –¢–µ—Å—Ç–æ–≤—ã–π —Å–∞–¥</strong><br>
                        <small>–ü—É—Ç—å: /test-garden/</small>
                    </a>
                `;
                
                // –ó–¥–µ—Å—å –≤ –±—É–¥—É—â–µ–º –º–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å —Ä–µ–∞–ª—å–Ω—ã–π –ø–æ–∏—Å–∫ –ø–∞–ø–æ–∫
                // —á–µ—Ä–µ–∑ AJAX –∏–ª–∏ —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–π —Å–ø–∏—Å–æ–∫
                
            } catch (error) {
                list.innerHTML = `<p style="color: #cf222e;">–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å–ø–∏—Å–∫–∞: ${error.message}</p>`;
            }
        }
        
        // –ó–∞–ø—É—Å–∫–∞–µ–º –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
        document.addEventListener('DOMContentLoaded', function() {
            updateDate();
            loadGardens();
            
            // –û–±–Ω–æ–≤–ª—è–µ–º –¥–∞—Ç—É –∫–∞–∂–¥—É—é –º–∏–Ω—É—Ç—É
            setInterval(updateDate, 60000);
        });
    </script>
    
    <footer style="margin-top: 40px; padding-top: 20px; border-top: 1px solid #e1e4e8; color: #6a737d;">
        <p>üöÄ –†–∞–∑–≤—ë—Ä–Ω—É—Ç–æ —Å –ø–æ–º–æ—â—å—é GitHub Actions</p>
        <p><a href="https://github.com/Story987/Grin">–ò—Å—Ö–æ–¥–Ω—ã–π –∫–æ–¥ –Ω–∞ GitHub</a></p>
    </footer>
</body>
</html>
EOF
          
          echo "‚úÖ –ì–ª–∞–≤–Ω–∞—è —Å—Ç—Ä–∞–Ω–∏—Ü–∞ —Å–æ–∑–¥–∞–Ω–∞: src/site/notes/index.html"
        
      # –®–ê–ì 3: –°–æ–∑–¥–∞—ë–º —Ç–µ—Å—Ç–æ–≤—ã–π —Å–∞–¥ (–µ—Å–ª–∏ –Ω–µ—Ç —Ä–µ–∞–ª—å–Ω—ã—Ö)
      - name: Create test garden (if empty)
        run: |
          cd src/site/notes/
          
          # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ —Ö–æ—Ç—å –æ–¥–Ω–∞ –ø–∞–ø–∫–∞
          if [ ! -d "test-garden" ] && [ $(find . -maxdepth 1 -type d ! -name "." | wc -l) -eq 0 ]; then
            echo "üìù –°–æ–∑–¥–∞—é —Ç–µ—Å—Ç–æ–≤—ã–π —Å–∞–¥..."
            mkdir -p "test-garden"
            cat > "test-garden/index.html" << 'EOF2'
<!DOCTYPE html>
<html>
<head><meta charset="UTF-8"><title>–¢–µ—Å—Ç–æ–≤—ã–π —Å–∞–¥</title></head>
<body>
    <h1>üå± –≠—Ç–æ —Ç–µ—Å—Ç–æ–≤—ã–π —Å–∞–¥</h1>
    <p>–ï—Å–ª–∏ –≤—ã —ç—Ç–æ –≤–∏–¥–∏—Ç–µ, –∑–Ω–∞—á–∏—Ç GitHub Pages —Ä–∞–±–æ—Ç–∞–µ—Ç –ø—Ä–∞–≤–∏–ª—å–Ω–æ!</p>
    <p><a href="../">‚Üê –ù–∞–∑–∞–¥ –∫ —Å–ø–∏—Å–∫—É —Å–∞–¥–æ–≤</a></p>
</body>
</html>
EOF2
            echo "‚úÖ –¢–µ—Å—Ç–æ–≤—ã–π —Å–∞–¥ —Å–æ–∑–¥–∞–Ω: test-garden/index.html"
          else
            echo "üìÅ –ü–∞–ø–∫–∏ —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É—é—Ç, —Ç–µ—Å—Ç–æ–≤—ã–π —Å–∞–¥ –Ω–µ —Å–æ–∑–¥–∞—é"
          fi
        
      # –®–ê–ì 4: –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º –∏ –¥–µ–ø–ª–æ–∏–º
      - name: Setup GitHub Pages
        uses: actions/configure-pages@v5
        
      - name: Upload to GitHub Pages
        uses: actions/upload-pages-artifact@v3
        with:
          path: 'src/site/notes/'
        
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
