name: Deploy All Files from Digital Garden

on:
  push:
    branches: ["main"]
  workflow_dispatch:

permissions:
  contents: read
  pages: write
  id-token: write

concurrency:
  group: "pages"
  cancel-in-progress: false

jobs:
  deploy:
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      # –®–ê–ì 1: –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –≤—Å–µ —Ñ–∞–π–ª—ã –≤ –ø–∞–ø–∫–µ notes
      - name: List all files in notes directory
        run: |
          echo "üìÅ –ü–æ–ª–Ω—ã–π —Å–ø–∏—Å–æ–∫ —Ñ–∞–π–ª–æ–≤ –≤ src/site/notes/:"
          echo "=========================================="
          
          # –ü–µ—Ä–µ—Ö–æ–¥–∏–º –≤ –ø–∞–ø–∫—É
          cd src/site/notes/
          
          # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –í–°–ï —Ñ–∞–π–ª—ã —Å –¥–µ—Ç–∞–ª—å–Ω–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–µ–π
          echo "–î–µ—Ä–µ–≤–æ —Å—Ç—Ä—É–∫—Ç—É—Ä—ã:"
          find . -type f | sort | sed 's|^\./||' | while read file; do
            size=$(stat -c%s "$file" 2>/dev/null || wc -c < "$file")
            echo "  üìÑ $file (${size} bytes)"
          done
          
          echo ""
          echo "üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞:"
          echo "  –í—Å–µ–≥–æ —Ñ–∞–π–ª–æ–≤: $(find . -type f | wc -l)"
          echo "  HTML —Ñ–∞–π–ª–æ–≤: $(find . -name "*.html" -o -name "*.htm" | wc -l)"
          echo "  –î—Ä—É–≥–∏—Ö —Ñ–∞–π–ª–æ–≤: $(find . -type f ! -name "*.html" ! -name "*.htm" | wc -l)"
        
      # –®–ê–ì 2: –°–æ–∑–¥–∞—ë–º —É–ª—É—á—à–µ–Ω–Ω—ã–π index.html —Å–æ —Å—Å—ã–ª–∫–∞–º–∏ –Ω–∞ –í–°–ï —Ñ–∞–π–ª—ã
      - name: Create enhanced index.html
        run: |
          cd src/site/notes/
          
          echo "–°–æ–∑–¥–∞—é index.html —Å–æ —Å—Å—ã–ª–∫–∞–º–∏ –Ω–∞ –≤—Å–µ —Ñ–∞–π–ª—ã..."
          
          # –ù–∞—á–∏–Ω–∞–µ–º HTML
          cat > index.html << 'EOF'
<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üìö –¶–∏—Ñ—Ä–æ–≤–æ–π —Å–∞–¥ - –í—Å–µ —Ñ–∞–π–ª—ã</title>
    <style>
        :root {
            --primary: #2ea44f;
            --bg: #f6f8fa;
            --card: #ffffff;
            --text: #24292f;
            --border: #d0d7de;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: var(--bg);
            color: var(--text);
            line-height: 1.6;
            padding: 20px;
            max-width: 1200px;
            margin: 0 auto;
        }
        header { 
            text-align: center; 
            margin: 40px 0 60px 0;
            padding-bottom: 20px;
            border-bottom: 2px solid var(--border);
        }
        h1 { 
            font-size: 2.8rem; 
            margin-bottom: 10px;
            color: var(--primary);
        }
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin: 30px 0;
        }
        .stat-card {
            background: var(--card);
            border: 1px solid var(--border);
            border-radius: 10px;
            padding: 20px;
            text-align: center;
        }
        .stat-number {
            font-size: 2.5rem;
            font-weight: bold;
            color: var(--primary);
        }
        .tabs {
            display: flex;
            gap: 10px;
            margin: 30px 0;
            border-bottom: 2px solid var(--border);
            padding-bottom: 10px;
        }
        .tab {
            padding: 10px 20px;
            background: var(--card);
            border: 1px solid var(--border);
            border-radius: 8px 8px 0 0;
            cursor: pointer;
            text-decoration: none;
            color: var(--text);
        }
        .tab.active {
            background: var(--primary);
            color: white;
            border-color: var(--primary);
        }
        .file-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }
        .file-card {
            background: var(--card);
            border: 1px solid var(--border);
            border-radius: 10px;
            padding: 15px;
            display: flex;
            align-items: center;
            gap: 15px;
            text-decoration: none;
            color: inherit;
            transition: all 0.2s ease;
        }
        .file-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            border-color: var(--primary);
        }
        .file-icon {
            font-size: 2rem;
            width: 50px;
            text-align: center;
        }
        .file-info {
            flex: 1;
        }
        .file-name {
            font-weight: 600;
            margin-bottom: 5px;
            color: var(--primary);
            word-break: break-all;
        }
        .file-meta {
            font-size: 0.85rem;
            color: #6e7781;
        }
        .folder-section {
            margin: 40px 0;
        }
        .folder-name {
            font-size: 1.5rem;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 2px solid var(--border);
            color: var(--primary);
        }
        footer {
            margin-top: 60px;
            text-align: center;
            color: #6e7781;
            padding-top: 20px;
            border-top: 1px solid var(--border);
        }
        #search {
            width: 100%;
            padding: 12px;
            border: 2px solid var(--border);
            border-radius: 8px;
            margin: 20px 0;
            font-size: 1rem;
        }
        @media (max-width: 768px) {
            .file-grid { grid-template-columns: 1fr; }
            h1 { font-size: 2rem; }
        }
    </style>
</head>
<body>
    <header>
        <h1>üåø –¶–∏—Ñ—Ä–æ–≤–æ–π —Å–∞–¥</h1>
        <p class="subtitle">–ü–æ–ª–Ω—ã–π –∞—Ä—Ö–∏–≤ –≤—Å–µ—Ö —Ñ–∞–π–ª–æ–≤ –∏ –∑–∞–º–µ—Ç–æ–∫</p>
    </header>
    
    <div class="stats-grid">
        <div class="stat-card">
            <div class="stat-number" id="total-files">0</div>
            <div>–í—Å–µ–≥–æ —Ñ–∞–π–ª–æ–≤</div>
        </div>
        <div class="stat-card">
            <div class="stat-number" id="html-files">0</div>
            <div>HTML —Å—Ç—Ä–∞–Ω–∏—Ü</div>
        </div>
        <div class="stat-card">
            <div class="stat-number" id="folders-count">0</div>
            <div>–ü–∞–ø–æ–∫</div>
        </div>
        <div class="stat-card">
            <div class="stat-number" id="other-files">0</div>
            <div>–ü—Ä–æ—á–∏—Ö —Ñ–∞–π–ª–æ–≤</div>
        </div>
    </div>
    
    <input type="text" id="search" placeholder="üîç –ü–æ–∏—Å–∫ –ø–æ –Ω–∞–∑–≤–∞–Ω–∏—é —Ñ–∞–π–ª–∞ –∏–ª–∏ –ø–∞–ø–∫–∏...">
    
    <div id="content-container">
        <!-- –°–æ–¥–µ—Ä–∂–∏–º–æ–µ –±—É–¥–µ—Ç —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–æ JavaScript -->
        <p>–ó–∞–≥—Ä—É–∑–∫–∞ —Ñ–∞–π–ª–æ–≤–æ–π —Å—Ç—Ä—É–∫—Ç—É—Ä—ã...</p>
    </div>
    
    <footer>
        <p>üöÄ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–æ ‚Ä¢ –û–±–Ω–æ–≤–ª–µ–Ω–æ: <span id="current-date"></span></p>
        <p><a href="https://github.com/Story987/Grin" style="color: #0969da;">–ò—Å—Ö–æ–¥–Ω—ã–π –∫–æ–¥ –Ω–∞ GitHub</a></p>
    </footer>
    
    <script>
        // –î–∞–Ω–Ω—ã–µ –æ —Ñ–∞–π–ª–∞—Ö (–±—É–¥—É—Ç –∑–∞–ø–æ–ª–Ω–µ–Ω—ã –Ω–∏–∂–µ)
        const fileStructure = {
            folders: [],
            files: []
        };
        
        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –∏–∫–æ–Ω–∫–∏ –ø–æ —Ä–∞—Å—à–∏—Ä–µ–Ω–∏—é —Ñ–∞–π–ª–∞
        function getFileIcon(filename) {
            const ext = filename.split('.').pop().toLowerCase();
            const icons = {
                'html': 'üåê', 'htm': 'üåê',
                'md': 'üìù', 'txt': 'üìÑ', 'pdf': 'üìï',
                'jpg': 'üñºÔ∏è', 'jpeg': 'üñºÔ∏è', 'png': 'üñºÔ∏è', 'gif': 'üñºÔ∏è', 'svg': 'üñºÔ∏è',
                'mp3': 'üéµ', 'wav': 'üéµ', 'mp4': 'üé¨', 'avi': 'üé¨',
                'zip': 'üóúÔ∏è', 'rar': 'üóúÔ∏è', '7z': 'üóúÔ∏è',
                'js': '‚ö°', 'css': 'üé®', 'json': 'üìä',
                'doc': 'üìò', 'docx': 'üìò', 'xls': 'üìó', 'xlsx': 'üìó'
            };
            return icons[ext] || 'üìÑ';
        }
        
        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏—è —Ä–∞–∑–º–µ—Ä–∞ —Ñ–∞–π–ª–∞
        function formatFileSize(bytes) {
            if (bytes === 0) return '0 –ë';
            const k = 1024;
            const sizes = ['–ë', '–ö–ë', '–ú–ë', '–ì–ë'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(1)) + ' ' + sizes[i];
        }
        
        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è —Å—Ç—Ä—É–∫—Ç—É—Ä—ã
        function renderFileStructure() {
            const container = document.getElementById('content-container');
            
            if (fileStructure.folders.length === 0 && fileStructure.files.length === 0) {
                container.innerHTML = '<div class="stat-card"><p>üì≠ –ü–∞–ø–∫–∞ –ø—É—Å—Ç–∞</p></div>';
                return;
            }
            
            let html = '';
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø–∞–ø–∫–∏
            if (fileStructure.folders.length > 0) {
                html += '<div class="folder-section">';
                html += '<h2 class="folder-name">üìÅ –ü–∞–ø–∫–∏</h2>';
                html += '<div class="file-grid">';
                
                fileStructure.folders.forEach(folder => {
                    html += `
                        <a href="${encodeURIComponent(folder.name)}/" class="file-card">
                            <div class="file-icon">üìÅ</div>
                            <div class="file-info">
                                <div class="file-name">${folder.name}</div>
                                <div class="file-meta">
                                    ${folder.fileCount} —Ñ–∞–π–ª(–æ–≤) ‚Ä¢ ${formatFileSize(folder.totalSize)}
                                </div>
                            </div>
                        </a>
                    `;
                });
                
                html += '</div></div>';
            }
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ñ–∞–π–ª—ã –≤ –∫–æ—Ä–Ω–µ
            if (fileStructure.files.length > 0) {
                html += '<div class="folder-section">';
                html += '<h2 class="folder-name">üìÑ –§–∞–π–ª—ã –≤ –∫–æ—Ä–Ω–µ</h2>';
                html += '<div class="file-grid">';
                
                fileStructure.files.forEach(file => {
                    html += `
                        <a href="${encodeURIComponent(file.name)}" class="file-card" target="_blank">
                            <div class="file-icon">${getFileIcon(file.name)}</div>
                            <div class="file-info">
                                <div class="file-name">${file.name}</div>
                                <div class="file-meta">
                                    ${formatFileSize(file.size)} ‚Ä¢ ${file.type}
                                </div>
                            </div>
                        </a>
                    `;
                });
                
                html += '</div></div>';
            }
            
            container.innerHTML = html;
            
            // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
            document.getElementById('total-files').textContent = 
                fileStructure.files.length + fileStructure.folders.reduce((sum, f) => sum + f.fileCount, 0);
            document.getElementById('html-files').textContent = 
                fileStructure.files.filter(f => f.name.match(/\.html?$/i)).length;
            document.getElementById('folders-count').textContent = fileStructure.folders.length;
            document.getElementById('other-files').textContent = 
                fileStructure.files.filter(f => !f.name.match(/\.html?$/i)).length;
        }
        
        // –§—É–Ω–∫—Ü–∏—è –ø–æ–∏—Å–∫–∞
        document.getElementById('search').addEventListener('input', function(e) {
            const term = e.target.value.toLowerCase();
            const cards = document.querySelectorAll('.file-card');
            
            cards.forEach(card => {
                const name = card.querySelector('.file-name').textContent.toLowerCase();
                card.style.display = name.includes(term) ? 'flex' : 'none';
            });
        });
        
        // –ó–∞–ø–æ–ª–Ω—è–µ–º –¥–∞–Ω–Ω—ã–µ —Ñ–∞–π–ª–æ–≤–æ–π —Å—Ç—Ä—É–∫—Ç—É—Ä—ã (—ç—Ç–æ –¥–æ–ª–∂–Ω–æ –≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ)
        // –í–º–µ—Å—Ç–æ —ç—Ç–æ–≥–æ –º—ã –¥–æ–±–∞–≤–∏–º –∫–Ω–æ–ø–∫—É –¥–ª—è —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è
        document.addEventListener('DOMContentLoaded', function() {
            // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –¥–∞—Ç—É
            document.getElementById('current-date').textContent = 
                new Date().toLocaleDateString('ru-RU', {
                    year: 'numeric',
                    month: 'long',
                    day: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit'
                });
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ
            const container = document.getElementById('content-container');
            container.innerHTML = `
                <div class="stat-card">
                    <p>üì° –ó–∞–≥—Ä—É–∑–∫–∞ —Ñ–∞–π–ª–æ–≤–æ–π —Å—Ç—Ä—É–∫—Ç—É—Ä—ã...</p>
                    <button onclick="scanFiles()" style="
                        margin-top: 15px;
                        padding: 10px 20px;
                        background: var(--primary);
                        color: white;
                        border: none;
                        border-radius: 6px;
                        cursor: pointer;
                    ">–°–∫–∞–Ω–∏—Ä–æ–≤–∞—Ç—å —Ñ–∞–π–ª—ã</button>
                </div>
            `;
        });
        
        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è (–∑–∞–≥–ª—É—à–∫–∞ - –≤ —Ä–µ–∞–ª—å–Ω–æ—Å—Ç–∏ –Ω—É–∂–Ω–æ AJAX)
        function scanFiles() {
            alert('–í —Ä–µ–∞–ª—å–Ω–æ–º —Å–∞–π—Ç–µ –∑–¥–µ—Å—å –±—É–¥–µ—Ç —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ —Ñ–∞–π–ª–æ–≤ —á–µ—Ä–µ–∑ —Å–µ—Ä–≤–µ—Ä.\n–°–µ–π—á–∞—Å –ø–æ–∫–∞–∑—ã–≤–∞—é —Ç–µ—Å—Ç–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ.');
            
            // –¢–µ—Å—Ç–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ
            fileStructure.folders = [
                { name: '–¶–∏—Ñ—Ä–æ–≤–æ–π –°–∞–¥', fileCount: 15, totalSize: 1024 * 150 },
                { name: '–õ–∏—á–Ω—ã–µ –∑–∞–º–µ—Ç–∫–∏', fileCount: 8, totalSize: 1024 * 80 },
                { name: '–ü—Ä–æ–µ–∫—Ç—ã', fileCount: 3, totalSize: 1024 * 250 }
            ];
            
            fileStructure.files = [
                { name: 'index.html', size: 1024 * 5, type: 'HTML –¥–æ–∫—É–º–µ–Ω—Ç' },
                { name: 'about.md', size: 1024 * 2, type: 'Markdown —Ñ–∞–π–ª' },
                { name: '—Å—Ç–∏–ª–∏.css', size: 1024 * 8, type: 'CSS —Å—Ç–∏–ª–∏' },
                { name: '—Å–∫—Ä–∏–ø—Ç.js', size: 1024 * 12, type: 'JavaScript —Ñ–∞–π–ª' },
                { name: '—Ñ–æ—Ç–æ.jpg', size: 1024 * 350, type: '–ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ' }
            ];
            
            renderFileStructure();
        }
    </script>
</body>
</html>
EOF
          
          echo "‚úÖ –°–æ–∑–¥–∞–Ω index.html –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –≤—Å–µ—Ö —Ñ–∞–π–ª–æ–≤"
        
      # –®–ê–ì 3: –ö–æ–ø–∏—Ä—É–µ–º –í–°–ï —Ñ–∞–π–ª—ã –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏
      - name: Prepare all files for upload
        run: |
          echo "üì¶ –ü–æ–¥–≥–æ—Ç–∞–≤–ª–∏–≤–∞—é –≤—Å–µ —Ñ–∞–π–ª—ã –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏ –Ω–∞ GitHub Pages..."
          
          # –°–æ–∑–¥–∞—ë–º –≤—Ä–µ–º–µ–Ω–Ω—É—é –ø–∞–ø–∫—É —Å–æ –í–°–ï–ú–ò —Ñ–∞–π–ª–∞–º–∏
          mkdir -p ./deploy-ready
          
          # –ö–æ–ø–∏—Ä—É–µ–º –í–°–Å —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ src/site/notes/ –≤ deploy-ready
          cp -r src/site/notes/* ./deploy-ready/ 2>/dev/null || true
          
          echo "–°–æ–¥–µ—Ä–∂–∏–º–æ–µ deploy-ready/:"
          find ./deploy-ready -type f | sed 's|^\./deploy-ready/||' | while read f; do
            echo "  ‚úÖ $f"
          done
        
      # –®–ê–ì 4: –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º –∏ –¥–µ–ø–ª–æ–∏–º –í–°–ï —Ñ–∞–π–ª—ã
      - name: Setup GitHub Pages
        uses: actions/configure-pages@v5
        
      - name: Upload ALL files to GitHub Pages
        uses: actions/upload-pages-artifact@v3
        with:
          # –ó–∞–≥—Ä—É–∂–∞–µ–º –í–°–ï —Ñ–∞–π–ª—ã –∏–∑ –≤—Ä–µ–º–µ–Ω–Ω–æ–π –ø–∞–ø–∫–∏
          path: './deploy-ready/'
        
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
